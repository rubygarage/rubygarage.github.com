<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta charset="utf-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
      <title>Models</title>
      <link href="assets/models.css" rel="stylesheet" />
      <script src="assets/models.js"></script>
   </head>
   <body class="deck-container">

<!-- Begin slides. Just make elements with a class of slide. -->
<section id="topic" class="slide"><div class="vcenter">
    <h1>Active Record Models</h1>
    <div class="about">
      <p><strong>Active Record</strong> is the <strong>M</strong> in <a href="http://en.wikipedia.org/wiki/Model–view–controller" target="_blank">MVC</a> - the model - which is the layer of the system responsible for representing business data and logic. It is an implementation of <a href="http://en.wikipedia.org/wiki/Active_record_pattern" target="_blank">the Active Record pattern</a> which itself is a description of an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping" target="_blank">Object Relational Mapping</a> (ORM) system.</p>
      <p>Active Record gives us several mechanisms, the most important being the ability to:</p>
      <ul><li>Represent models and their data</li>
        <li>Represent associations between these models</li>
        <li>Represent inheritance hierarchies through related models</li>
        <li>Validate models before they get persisted to the database</li>
        <li>Perform database operations in an object-oriented fashion</li>
      </ul></div>
  </div>
</section><section id="models-generation" class="slide"><h2>Models generation</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
     rails generate model User first_name:string email:string password:string
      invoke  active_record
      create    db/migrate/20130602143931_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      test/unit/user_test.rb
      create      test/fixtures/users.yml

    ]]]]><![CDATA[>
  ]]></script><h3>Naming Conventions</h3>
  <ul><li>Database Table - Plural with underscores separating words (e.g., book_clubs)</li>
    <li>Model Class - Singular with the first letter of each word capitalized (e.g., BookClub)</li>
  </ul><table class="naming-conventions"><thead><tr><th>Model / Class</th>
        <th>Table / Schema</th>
      </tr></thead><tbody><tr><td><code>Post</code></td>
        <td><code>posts</code></td>
      </tr><tr><td><code>LineItem</code></td>
        <td><code>line_items</code></td>
      </tr><tr><td><code>Deer</code></td>
        <td><code>deer</code></td>
      </tr><tr><td><code>Mouse</code></td>
        <td><code>mice</code></td>
      </tr><tr><td><code>Person</code></td>
        <td><code>people</code></td>
      </tr></tbody></table></section><section id="migrations-topic" class="slide"><div class="vcenter">
    <h1>Active Record Migrations</h1>
    <div class="about">
      <p><strong>Migrations</strong> are a feature of Active Record that allows you to evolve your database schema over time. Rather than write schema modifications in pure SQL, migrations allow you to use an easy Ruby DSL to describe changes to your tables.</p>
    </div>
  </div>
</section><section id="migrations" class="slide"><h2>Overview</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      class CreateUsers < ActiveRecord::Migration
        def change
          create_table :users do |t|
            t.string :first_name
            t.string :email
            t.string :password

            t.timestamps
          end
        end
      end
    ]]]]><![CDATA[>
  ]]></script><h3>Schema Conventions</h3>
  <ul><li><strong>Foreign keys</strong> - These fields should be named following the pattern singularized_table_name_id (e.g., item_id, order_id). These are the fields that Active Record will look for when you create associations between your models.</li>
    <li><strong>Primary keys</strong> - By default, Active Record will use an integer column named id as the table's primary key. When using Rails Migrations to create your tables, this column will be automatically created.</li>
    <li><strong>created_at</strong> - Automatically gets set to the current date and time when the record is first created.</li>
    <li><strong>updated_at</strong> - Automatically gets set to the current date and time whenever the record is updated.</li>
    <li><strong>lock_version</strong> - Adds optimistic locking to a model.</li>
    <li><strong>type</strong> - Specifies that the model uses Single Table Inheritance.</li>
    <li><strong>(association_name)_type</strong> - Stores the type for polymorphic associations.</li>
    <li><strong>(table_name)_count</strong> - Used to cache the number of belonging objects on associations. For example, a comments_count column in a Post class that has many instances of Comment will cache the number of existent comments for each post.</li>
  </ul></section><section id="add-migrations" class="slide"><h2>Add Migrations</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
  <![CDATA[
    rails g migration AddLastNameToUsers last_name:string
      invoke  active_record
      create    db/migrate/20130602150030_add_last_name_to_users.rb

  ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
  <![CDATA[
    YYYYMMDDHHMMSS UTC timestamp
    20130602150030_add_last_name_to_users.rb
  ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130602150030_add_last_name_to_users.rb 
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
  <![CDATA[
     class AddLastNameToUsers < ActiveRecord::Migration
      def change
        add_column :users, :last_name, :string
      end
    end
  ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
  <![CDATA[
    rails g migration AddReceiveNewsToUsers receive_news:boolean
      invoke  active_record
      create    db/migrate/20130602151002_add_receive_news_to_users.rb
  ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130602151002_add_receive_news_to_users.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
  <![CDATA[
    class AddReceiveNewsToUsers < ActiveRecord::Migration
      def change
        add_column :users, :receive_news, :boolean
      end
    end
  ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130602151002_add_receive_news_to_users.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
  <![CDATA[
    class AddReceiveNewsToUsers < ActiveRecord::Migration
      def up
        change_table :users do |t|
          t.boolean :receive_news, default: true
          t.index :receive_news
        end

        User.update_all ["receive_news = ?", true]
      end

      def down
        remove_column :users, :receive_news
      end
    end
  ]]]]><![CDATA[>
  ]]></script></section><section id="db-changing-methods" class="slide"><h2>Methods for db structure changing</h2>
  
  <code>create_table</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
      create_table :friends do |t|
        t.string :first_name
        t.string :last_name
        t.string :email
        t.timestamps
      end
    ]]]]><![CDATA[>
  ]]></script><code>change_table</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
      change_table :friends do |t|
        t.remove :last_name, :first_name
        t.string :phone_number
        t.index  :phone_number
      end
    ]]]]><![CDATA[>
  ]]></script><code>add_column</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      add_column :friends, :first_name, :string
      add_column :friends, :last_name, :integer
    ]]]]><![CDATA[>
  ]]></script><code>change_column</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      change_column :friends, :last_name, :string
    ]]]]><![CDATA[>
  ]]></script><code>rename_column</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      rename_column :friends, :last_name, :surname
    ]]]]><![CDATA[>
  ]]></script><code>remove_column</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      remove_column :friends, :surname
    ]]]]><![CDATA[>
  ]]></script><code>add_index</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      add_index :friends, :email
    ]]]]><![CDATA[>
  ]]></script><code>remove_index</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      remove_index :friends, :email
    ]]]]><![CDATA[>
  ]]></script><code>drop_table</code>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      drop_table :friends
    ]]]]><![CDATA[>
  ]]></script></section><section id="column-types" class="slide"><h2>Column Types</h2>
  <ul><li><code>:binary</code></li>
    <li><code>:boolean</code></li>
    <li><code>:date</code></li>
    <li><code>:datetime</code></li>
    <li><code>:decimal</code></li>
    <li><code>:float</code></li>
    <li><code>:integer</code></li>
    <li><code>:primary_key</code></li>
    <li><code>:string</code></li>
    <li><code>:text</code></li>
    <li><code>:time</code></li>
    <li><code>:timestamp</code></li>
    <li><code>:references</code></li>
  </ul></section><section id="example-migration" class="slide"><h2>Example Migration</h2>

  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class ExampleMigration < ActiveRecord::Migration
      def up
        create_table :users do |t|
          t.references :group
        end
        #add a foreign key
        execute <<-SQL
          ALTER TABLE products
            ADD CONSTRAINT fk_users_groups
            FOREIGN KEY (group_id)
            REFERENCES groups(id)
        SQL
        add_column :users, :home_page_url, :string
        rename_column :users, :email, :email_address
      end
     
      def down
        rename_column :users, :email_address, :email
        remove_column :users, :home_page_url
        execute <<-SQL
          ALTER TABLE users
            DROP FOREIGN KEY fk_users_groups
        SQL
        drop_table :users
      end
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="running-migrations" class="slide"><h2>Run run run ruuuuuuuuun</h2>
  <h3>Running Migrations</h3>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
        rake db:migrate     
    ]]]]><![CDATA[>
  ]]></script><h3>Rollback Migrations</h3>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
        rake db:rollback
        rake db:rollback STEP=3
        rake db:migrate:down VERSION=20111214211749  
        rake db:migrate:up VERSION=20111214211749
        rake db:migrate:redo STEP=3
           
    ]]]]><![CDATA[>
  ]]></script></section><section id="topic-active-record-objects" class="slide"><div class="vcenter">
    <h1>Active Record Objects</h1>
  </div>
</section><section id="activerecord-functions" class="slide"><h2>ActiveRecord functions</h2>
  
  <h3>new, all, save</h3>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    rails c  # rails console 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    2.0.0-p0 :003 > user = User.new
     => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false >]   
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    2.0.0-p0 :001 > user.first_name = "Anna"
     => "Anna" 
    2.0.0-p0 :003 > user.email = "happy_ann@gmail.com"
     => "happy_ann@gmail.com" 
    2.0.0-p0 :004 > user.save
      (0.2ms)  begin transaction
      SQL (29.9ms)  INSERT INTO "users" ("created_at", "email", "first_name", "last_name", "password", "receive_news", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 17:23:02 UTC +00:00], ["email", "happy_ann@gmail.com"], ["first_name", "Anna"], ["last_name", nil], ["password", nil], ["receive_news", false], ["updated_at", Sun, 02 Jun 2013 17:23:02 UTC +00:00]]
       (125.5ms)  commit transaction
     => true 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    2.0.0-p0 :005 > User.all
      User Load (0.4ms)  SELECT "users".* FROM "users" 
     => [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>]  
    ]]]]><![CDATA[>
  ]]></script><h3>Rails 3</h3>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    2.0.0-p0 :006 > User.all.class
      User Load (0.6ms)  SELECT "users".* FROM "users" 
     => Array 
    
    ]]]]><![CDATA[>
  ]]></script><h3>Rails 4</h3>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    2.0.0-p0 :007 > User.all.class
      User Load (0.6ms)  SELECT "users".* FROM "users" 
     => ActiveRecord::Relation     
    ]]]]><![CDATA[>
  ]]></script></section><section id="activerecord-functions-part2" class="slide"><h2>ActiveRecord functions</h2>
  <h3>create, count, update_attributes</h3>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[  
    2.0.0-p0 :001 > new_user = User.create(first_name: "Ivan", email: "ivan.melechov@gmail.com")
      (0.1ms)  begin transaction
      SQL (3.0ms)  INSERT INTO "users" ("created_at", "email", "first_name", "last_name", "password", "receive_news", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 18:18:40 UTC +00:00], ["email", "ivan.melechov@gmail.com"], ["first_name", "Ivan"], ["last_name", nil], ["password", nil], ["receive_news", false], ["updated_at", Sun, 02 Jun 2013 18:18:40 UTC +00:00]]
      (125.0ms)  commit transaction
     => #<User id: 2, first_name: "Ivan", email: "ivan.melechov@gmail.com", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:18:40", last_name: nil, receive_news: false> 
  ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
   <![CDATA[  
   2.0.0-p0 :002 > User.count
     (0.2ms)  SELECT COUNT(*) FROM "users" 
    => 2      
   ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[  
    2.0.0-p0 :003 > new_user.update_attributes(first_name: "Van'ka", email: "vanka@yandex.ru")
     (0.2ms)  begin transaction
     (0.5ms)  UPDATE "users" SET "first_name" = 'Van''ka', "email" = 'vanka@yandex.ru', "updated_at" = '2013-06-02 18:20:00.982364' WHERE "users"."id" = 2
     (124.8ms)  commit transaction
     => true 
        
    ]]]]><![CDATA[>
  ]]></script></section><section id="topic-associations" class="slide"><div class="vcenter">
    <h1>Active Record Associations</h1>
  </div>
</section><section id="belongs-to" class="slide"><h2>belongs_to</h2>
  <img src="/public/models/assets/belongs_to.png" /></section><section id="belongs-to-in-model" class="slide"><h2>belongs_to</h2>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
      rails g migration AddUserRefToPosts user:references
      invoke  active_record
      create    db/migrate/20130615164224_add_user_ref_to_posts.rb
    ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130615164224_add_user_ref_to_posts.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[      
      class AddUserRefToPosts < ActiveRecord::Migration
        def change
          add_reference :posts, :user, index: true
        end
      end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
      rake db:migrate
      ==  AddUserRefToPosts: migrating ==============================================
      -- add_reference(:posts, :user, {:index=>true})
         -> 0.0053s
      ==  AddUserRefToPosts: migrated (0.0054s) =====================================
    ]]]]><![CDATA[>
  ]]></script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[      
    class Post < ActiveRecord::Base
      belongs_to :user
    end    
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > user = User.first
      User Load (0.4ms)  SELECT "users".* FROM "users" LIMIT 1
      => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    > post = Post.create(text: "I'm so happy today", title: "So happy", user_id: user.id) 
      (0.1ms)  begin transaction
      SQL (29.2ms)  INSERT INTO "posts" ("created_at", "text", "title", "updated_at", "user_id") VALUES (?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 18:43:10 UTC +00:00], ["text", "I'm so happy today"], "So happy", ["updated_at", Sun, 02 Jun 2013 18:43:10 UTC +00:00], ["user_id", 1]]
      (126.0ms)  commit transaction
      => #<Post id: 1, text: "I'm so happy today", title: "So happy", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10"> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > post.user
      User Load (0.4ms)  SELECT "users".* FROM "users" WHERE "users"."id" = 1 LIMIT 1
      => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>  
    ]]]]><![CDATA[>
  ]]></script></section><section id="has-many" class="slide"><h2>has_many</h2>
  <img src="/public/models/assets/has_many.png" /></section><section id="has_many_in_model" class="slide"><h2>has_many</h2>

  app/models/user.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class User < ActiveRecord::Base
      has_many :posts
    end     
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    > user.posts
      Post Load (0.2ms)  SELECT "posts".* FROM "posts" WHERE "posts"."user_id" = 1
      => [#<Post id: 1, text: "I'm so happy today", title: "So happy", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10">] 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > user.posts << Post.new(text: "I'm waiting")
      (0.2ms)  begin transaction
      SQL (32.4ms)  INSERT INTO "posts" ("created_at", "text",  "updated_at", "user_id") VALUES (?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 19:01:45 UTC +00:00], ["text", "I'm waiting"], ["updated_at", Sun, 02 Jun 2013 19:01:45 UTC +00:00], ["user_id", 1]]
      (203.0ms)  commit transaction
      => [#<Post id: 1, text: "I'm so happy today", title: "So happy", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10">, #<Post id: 2, text: "I'm waiting", title: nil, user_id: 1, created_at: "2013-06-02 19:01:45", updated_at: "2013-06-02 19:01:45">] 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    > user.posts
      => [#<Post id: 1, text: "I'm so happy today", title: "So happy", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10">, #<Post id: 2, text: "I'm waiting", title: nil, user_id: 1, created_at: "2013-06-02 19:01:45", updated_at: "2013-06-02 19:01:45">] 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    > user.posts.count
      (0.2ms)  SELECT COUNT(*) FROM "posts" WHERE "posts"."user_id" = 1
      => 2 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    > user.posts.create(text: "New post")
      (0.2ms)  begin transaction
      SQL (0.8ms)  INSERT INTO "posts" ("created_at", "text","updated_at", "user_id") VALUES (?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 19:06:35 UTC +00:00], ["text", "New post"], ["updated_at", Sun, 02 Jun 2013 19:06:35 UTC +00:00], ["user_id", 1]]
      (140.8ms)  commit transaction
      => #<Post id: 3, text: "New post", title: nil, user_id: 1, created_at: "2013-06-02 19:06:35", updated_at: "2013-06-02 19:06:35"> 
    ]]]]><![CDATA[>
  ]]></script></section><section id="has-one" class="slide"><h2>has_one</h2>
  <img src="/public/models/assets/has_one.png" /></section><section id="has-one-in-model" class="slide"><h2>has_one</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    rails g model PostInfo post_id:integer views:integer likes:integer rating:integer
    ]]]]><![CDATA[>
  ]]></script>

  app/models/post_info.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[      
    class PostInfo < ActiveRecord::Base
      belongs_to :post
    end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[      
    class Post < ActiveRecord::Base
      belongs_to :user
      has_one :post_info
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > post = Post.first
      Post Load (0.1ms)  SELECT "posts".* FROM "posts" LIMIT 1
      => #<Post id: 1, text: "I'm so happy today", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10"> 

    ]]]]><![CDATA[>
  ]]></script>

  Creation PostInfo
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > PostInfo.create(post_id: post.id, views: 40, likes: 5, rating: 10)
      (0.1ms)  begin transaction
      SQL (5.1ms)  INSERT INTO "post_infos" ("created_at", "likes", "post_id", "rating", "updated_at", "views") VALUES (?, ?, ?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 19:37:08 UTC +00:00], ["likes", 5], ["post_id", 1], ["rating", 10], ["updated_at", Sun, 02 Jun 2013 19:37:08 UTC +00:00], ["views", 40]]
      (116.2ms)  commit transaction
      => #<PostInfo id: 2, post_id: 1, views: 40, likes: 5, rating: 10, created_at: "2013-06-02 19:37:08", updated_at: "2013-06-02 19:37:08"> 
    ]]]]><![CDATA[>
  ]]></script>

  Creation using the association
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > post.create_post_info(views: 40, likes: 5, rating: 10)
      (0.2ms)  begin transaction
      SQL (29.4ms) INSERT INTO "post_infos" ("created_at", "likes", "post_id", "rating", "updated_at", "views") VALUES (?, ?, ?, ?, ?, ?)  [["created_at", Sun, 16 Jun 2013 20:21:58 UTC +00:00], ["likes", 5], ["post_id", 1], ["rating", 10], ["updated_at", Sun, 16 Jun 2013 20:21:58 UTC +00:00], ["views", 40]]
      (1.5ms)  commit transaction
      => #<PostInfo id: 1, post_id: 1, views: 40, likes: 5, rating: 10, created_at: "2013-06-16 20:21:58", updated_at: "2013-06-16 20:21:58">
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > post.post_info
      PostInfo Load (0.2ms)  SELECT "post_infos".* FROM "post_infos" WHERE "post_infos"."post_id" = 1 LIMIT 1
      => #<PostInfo id: 1, post_id: 1, views: 40, likes: 5, rating: 10, created_at: "2013-06-02 19:34:38", updated_at: "2013-06-02 19:34:38"> 
    ]]]]><![CDATA[>
  ]]></script></section><section id="has-many-through" class="slide"><h2>has_many :through</h2>
  <img src="/public/models/assets/has_many_through.png" /></section><section id="has-many-through-in-model" class="slide"><h2>has_many :through</h2>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      rails g model Blog title:string description:text
      invoke  active_record
      create    db/migrate/20130615195018_create_blogs.rb
      create    app/models/blog.rb
      invoke    test_unit
      create      test/models/blog_test.rb
      create      test/fixtures/blogs.yml
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      rails g model Subscription user:belongs_to blog:belongs_to receive_news:boolean
      invoke  active_record
      create    db/migrate/20130615200154_create_subscriptions.rb
      create    app/models/subscription.rb
      invoke    test_unit
      create      test/models/subscription_test.rb
      create      test/fixtures/subscriptions.yml
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      rails g migration AddBlogRefToPosts blog:references
      invoke  active_record
      create    db/migrate/20130616200237_add_blog_ref_to_posts.rb
    ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130615195018_create_blogs.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      class CreateBlogs < ActiveRecord::Migration
        def change
          create_table :blogs do |t|
            t.string :title
            t.text :description

            t.timestamps
          end
        end
      end
    ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130615200154_create_subscriptions.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      class CreateSubscriptions < ActiveRecord::Migration
        def change
          create_table :subscriptions do |t|
            t.belongs_to :user, index: true
            t.belongs_to :blog, index: true
            t.boolean :receive_news, default: true

            t.timestamps
          end
        end
      end
    ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130616200237_add_blog_ref_to_posts.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      class AddBlogRefToPosts < ActiveRecord::Migration
        def change
          add_reference :posts, :blog, index: true
        end
      end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/user.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      class User < ActiveRecord::Base
        has_many :posts
        has_many :subscriptions
        has_many :blogs, through: :subscriptions
      end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/blog.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      class Blog < ActiveRecord::Base
        has_many :subscriptions
        has_many :users, through: :subscriptions
      end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/subscription.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      class Subscription < ActiveRecord::Base
        belongs_to :user
        belongs_to :blog
      end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      class Post < ActiveRecord::Base
        belongs_to :user
        belongs_to :blog
        has_one :post_info
        has_and_belongs_to_many :tags
      end
    ]]]]><![CDATA[>
  ]]></script></section><section id="has-one-through" class="slide"><h2>has_one :through</h2>
  <img src="/public/models/assets/has_one_through.png" /></section><section id="has-one-through-in-model" class="slide"><h2>has_one :through</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    rails g model Plan name:string description:text price:decimal{8.2}
      invoke  active_record
      create    db/migrate/20130616211135_create_plans.rb
      create    app/models/plan.rb
      invoke    test_unit
      create      test/models/plan_test.rb
      create      test/fixtures/plans.yml
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    rails g model UserPlan user:belongs_to plan:belongs_to
      invoke  active_record
      create    db/migrate/20130616211306_create_user_plans.rb
      create    app/models/user_plan.rb
      invoke    test_unit
      create      test/models/user_plan_test.rb
      create      test/fixtures/user_plans.yml
    ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130616211135_create_plans.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class CreatePlans < ActiveRecord::Migration
      def change
        create_table :plans do |t|
          t.string :name
          t.text :description
          t.decimal :price, precision: 8, scale: 2

          t.timestamps
        end
      end
    end
    ]]]]><![CDATA[>
  ]]></script>


  db/migrate/20130616211306_create_user_plans.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class CreateUserPlans < ActiveRecord::Migration
      def change
        create_table :user_plans do |t|
          t.belongs_to :user, index: true
          t.belongs_to :plan, index: true

          t.timestamps
        end
      end
    end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/user.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class User < ActiveRecord::Base
      has_many :posts
      has_many :subscriptions
      has_many :blogs, through: :subscriptions
      has_one :user_plan
      has_one :plan, through: :user_plan
    end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/user_plan.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class UserPlan < ActiveRecord::Base
      belongs_to :user
      belongs_to :plan
    end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/plan.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
  <![CDATA[    
    class Plan < ActiveRecord::Base
      has_many :user_plans
      has_many :users, through: :user_plans
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="has_and_belongs_to_many" class="slide"><h2>has_and_belongs_to_many</h2>
  <img src="/public/models/assets/has_and_belongs_to_many.png" /></section><section id="habtm-in-model" class="slide"><h2>has_and_belongs_to_many</h2>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    rails g model Tag name:string
      invoke  active_record
      create    db/migrate/20130615203349_create_tags.rb
      create    app/models/tag.rb
      invoke    test_unit
      create      test/models/tag_test.rb
      create      test/fixtures/tags.yml
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    rails g migration create_posts_tags post:references tag:references --no-timestamp
      invoke  active_record
      create    db/migrate/20130615205723_create_posts_tags.rb
    ]]]]><![CDATA[>
  ]]></script><h3>Rails 4</h3>
    <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    create_join_table :posts, :tags
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    create_join_table :posts, :tags, table_name: :tags_for_posts
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
      create_join_table :posts, :tags, column_options:  {null:  true}
    ]]]]><![CDATA[>
  ]]></script>
 
  db/migrate/20130615205723_create_posts_tags.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class CreatePostsTags < ActiveRecord::Migration
      def change
        create_table :posts_tags do |t|
          t.references :post, index: true
          t.references :tag, index: true
        end
      end
    end
    ]]]]><![CDATA[>
  ]]></script><h4>Change migration. Add common index and remove id.</h4>
  db/migrate/20130615205723_create_posts_tags.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class CreatePostsTags < ActiveRecord::Migration
      def change
        create_table :posts_tags, id: false do |t|
          t.references :post, index: true
          t.references :tag, index: true
        end
        add_index :posts_tags, [:post_id, :tag_id]
      end
    end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
      class Post < ActiveRecord::Base
        belongs_to :user
        has_and_belongs_to_many :tags
      end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/tag.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
  <![CDATA[    
    class Tag < ActiveRecord::Base
      has_and_belongs_to_many :posts
    end  
  ]]]]><![CDATA[>
  ]]></script></section><section id="polymorphic" class="slide"><h2>Polymorphic Associations</h2>
  <img src="/public/models/assets/polymorphic.png" /></section><section id="polymorphic-in-model" class="slide"><h2>Polymorphic Assosiations</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      rails g model Picture imageable:references{polymorphic} file:string
      invoke  active_record
      create    db/migrate/20130616213914_create_pictures.rb
      create    app/models/picture.rb
      invoke    test_unit
      create      test/models/picture_test.rb
      create      test/fixtures/pictures.yml
    ]]]]><![CDATA[>
  ]]></script>

  db/migrate/20130616213914_create_pictures.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class CreatePictures < ActiveRecord::Migration
      def change
        create_table :pictures do |t|
          t.references :imageable, polymorphic: true, index: true
          t.string :file

          t.timestamps
        end
      end
    end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/picture.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class Picture < ActiveRecord::Base
      belongs_to :imageable, polymorphic: true
    end      
    ]]]]><![CDATA[>
  ]]></script>

  app/models/user.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class User < ActiveRecord::Base
      has_many :posts
      has_many :subscriptions
      has_many :blogs, through: :subscriptions
      has_one :user_plan
      has_one :plan, through: :user_plan
      has_one :picture, as: :imageable
    end
    ]]]]><![CDATA[>
  ]]></script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class Post < ActiveRecord::Base
      belongs_to :user
      belongs_to :blog
      has_one :post_info
      has_and_belongs_to_many :tags
      has_many :pictures, as: :imageable
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > user.create_picture(file: 'public/picture/photo.png')
      (0.1ms)  begin transaction
      SQL (32.7ms)  INSERT INTO "pictures" ("created_at", "file", "imageable_id", "imageable_type", "updated_at") VALUES (?, ?, ?, ?, ?)  [["created_at", Sun, 16 Jun 2013 21:46:37 UTC +00:00], ["file", "public/picture/photo.png"], ["imageable_id", 1], ["imageable_type", "User"], ["updated_at", Sun, 16 Jun 2013 21:46:37 UTC +00:00]]
      (1.5ms)  commit transaction
      Picture Load (0.4ms)  SELECT "pictures".* FROM "pictures" WHERE "pictures"."imageable_id" = ? AND "pictures"."imageable_type" = ? ORDER BY "pictures"."id" ASC LIMIT 1  [["imageable_id", 1], ["imageable_type", "User"]]
      => #<Picture id: 1, imageable_id: 1, imageable_type: "User", file: "public/picture/photo.png", created_at: "2013-06-16 21:46:37", updated_at: "2013-06-16 21:46:37">
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > post.pictures.create(file: 'public/picture/image.png')
      (0.1ms)  begin transaction
      SQL (0.6ms)  INSERT INTO "pictures" ("created_at", "file", "imageable_id", "imageable_type", "updated_at") VALUES (?, ?, ?, ?, ?)  [["created_at", Sun, 16 Jun 2013 21:51:25 UTC +00:00], ["file", "public/picture/image.png"], ["imageable_id", 1], ["imageable_type", "Post"], ["updated_at", Sun, 16 Jun 2013 21:51:25 UTC +00:00]]
      (1.7ms)  commit transaction
      => #<Picture id: 2, imageable_id: 1, imageable_type: "Post", file: "public/picture/image.png", created_at: "2013-06-16 21:51:25", updated_at: "2013-06-16 21:51:25">
    ]]]]><![CDATA[>
  ]]></script></section><section id="topic-validations" class="slide"><div class="vcenter">
    <h1>Active Record Validations</h1>
  </div>
</section><section id="when-does-validation-happen" class="slide"><h2>When Does Validations Happen?</h2>
  <ul><li><code>create</code></li>
    <li><code>create!</code></li>
    <li><code>save</code></li>
    <li><code>save!</code></li>
    <li><code>update</code></li>
    <li><code>update!</code></li>
  </ul></section><section id="skipping-validations" class="slide"><h2>Skiping Validations</h2>
  <ul><li><code>decrement!</code></li>
    <li><code>decrement_counter</code></li>
    <li><code>increment!</code></li>
    <li><code>increment_counter</code></li>
    <li><code>toggle!</code></li>
    <li><code>touch</code></li>
    <li><code>update_all</code></li>
    <li><code>update_attribute</code></li>
    <li><code>update_column</code></li>
    <li><code>update_columns</code></li>
    <li><code>update_counters</code></li>
    <li><code>save(validate: false)</code></li>
  </ul></section><section id="valid-invalid" class="slide"><h2>valid? and invalid?</h2>

  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[      
    class User < ActiveRecord::Base
      has_many :posts
      validates :email, presence: true
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > User.new(email: "thebestemail@ua.fm").valid?
      => true 
    > User.new().valid?
      => false 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > u = User.new
      => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false> 
    > u.errors
      => #<ActiveModel::Errors:0x00000003001970 @base=#<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false>, @messages={}> 
    > u.valid?
      => false 
    > u.errors
      => #<ActiveModel::Errors:0x00000003001970 @base=#<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false>, @messages={:email=>["can't be blank"]}> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > u = User.create
        (0.2ms)  begin transaction
        (0.1ms)  rollback transaction
      => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false> 
    > u.errors
      => #<ActiveModel::Errors:0x00000003172db8 @base=#<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false>, @messages={:email=>["can't be blank"]}> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > u = User.new
      => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false> 
    > u.save
        (0.2ms)  begin transaction
        (0.1ms)  rollback transaction
      => false 
    > u.save!
       (0.1ms)  begin transaction
       (0.1ms)  rollback transaction
      ActiveRecord::RecordInvalid: Validation failed: Email cant be blank
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > User.create
        (0.1ms)  begin transaction
        (0.1ms)  rollback transaction
      => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false> 
    > User.create!
        (0.1ms)  begin transaction
        (0.1ms)  rollback transaction
      ActiveRecord::RecordInvalid: Validation failed: Email cant be blank
    ]]]]><![CDATA[>
  ]]></script></section><section id="errors" class="slide"><h2>errors[]</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    > User.new.errors[:email].any?
      => false 
    > User.create.errors[:email].any?
       (0.1ms)  begin transaction
       (0.1ms)  rollback transaction
      => true 
    ]]]]><![CDATA[>
  ]]></script></section><section id="topic-validation-helpers" class="slide"><div class="vcenter">
    <h1>Active Record Validations</h1>
    <h2>Helpers</h2>
  </div>
</section><section id="presence" class="slide"><h2>Presence</h2>
<script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class User < ActiveRecord::Base
      attr_accessible :email, :first_name, :password

      has_many :posts
      validates :email, :first_name, presence: true
    end     
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    validates :field_name, inclusion: { in:  [true, false] }. # for fields with boolean type
    ]]]]><![CDATA[>
  ]]></script></section><section id="acceptance" class="slide"><h2>Acceptance</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[       
    rails g migration AddTermsOfServiceToUsers terms_of_service:boolean
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[       
    class User < ActiveRecord::Base  
      ... 
      validates :terms_of_service, acceptance: true  # get accept: 1
    end   
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[     
    class User < ActiveRecord::Base   
      ...
      validates :terms_of_service, acceptance: { accept: 'yes' }  
    end
    ]]]]><![CDATA[>
  ]]></script><p>Do not this validation on the both sides of the association it causes endless cycle.</p>

</section><section id="validates-associated" class="slide"><h2>Validates Assosiated</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base  
      ... 
      has_many :posts
      validates_associated :posts
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="confirmation" class="slide"><h2>Confirmation</h2>
<script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[       
    class User < ActiveRecord::Base
      ...
      validates :email, :first_name, presence: true
      validates :email, confirmation: true
    end 
    ]]]]><![CDATA[>
  ]]></script></section><section id="exclusion" class="slide"><h2>Exclusion</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class User < ActiveRecord::Base
      ...
      validates :first_name, exclusion: { in:  %w(Admin BadDog),  message:  "First name %{value} is invalid." }
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="format" class="slide"><h2>Format</h2>
<script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class User < ActiveRecord::Base
      ...
      validates :email, :first_name, presence: true
      validates :email, confirmation: true
      validates :email, format: { with: /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/, :message => "Only emails allowed" }
    end    
    ]]]]><![CDATA[>
  ]]></script></section><section id="inclusion" class="slide"><h2>Inclusion</h2>
<script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class Tag < ActiveRecord::Base
      ...
      validates :name, inclusion: { in: %w(reading cooking programming), message: "%{value} is not a valid value" }
    end   
    ]]]]><![CDATA[>
  ]]></script></section><section id="length" class="slide"><h2>Length</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[ 
    rails g migration AddCardNumberToUsers card_number:string
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class User < ActiveRecord::Base
      ...
      validates :first_name, length: { 
        minimum: 2, 
        maximum: 500, 
        wrong_length: "Invalid length",
        too_long: "%{count} characters is the maximum allowed" 
        too_short: "must have at least %{count} characters"
      }
      validates :password, length: { in: 6..20 }
      validates :card_number, length:  { is: 14 }
    end
    ]]]]><![CDATA[>
  ]]></script><ul><li><code>:minimum</code> – The attribute cannot have less than the specified length.</li>
    <li><code>:maximum</code> – The attribute cannot have more than the specified length.</li>
    <li><code>:in</code> (or <code>:within</code>) – The attribute length must be included in a given interval. The value for this option must be a range.</li>
    <li><code>:is</code> – The attribute length must be equal to the given value.</li>
  </ul></section><section id="numericality" class="slide"><h2>Numericality</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class PostInfo < ActiveRecord::Base
      ...
      validates :views, numericality: true
      validates :rate, numericality: { only_integer: true, greater_than: 5 }
    end   
    ]]]]><![CDATA[>
  ]]></script><ul><li><code>:greater_than</code></li>
    <li><code>:greater_than_or_equal_to</code></li>
    <li><code>:equal_to</code></li>
    <li><code>:less_than</code></li>
    <li><code>:less_than_or_equal_to</code></li>
    <li><code>:odd</code></li>
    <li><code>:even</code></li>
  </ul></section><section id="uniqueness" class="slide"><h2>Uniqueness</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
    rails g AddPageAddressToUsers page_address:string    
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class User < ActiveRecord::Base
      ... 
      validates :email, uniqueness: true
      validates :first_name, uniqueness: { scope: :email,  message: "should only one user with name and email" }
      validates :page_address, uniqueness: { case_sensitive:  false }
    end
    
    ]]]]><![CDATA[>
  ]]></script></section><section id="validates-with" class="slide"><h2>validates_with</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base
      validates_with GoodnessValidator
    end
     
    class GoodnessValidator < ActiveModel::Validator
      def validate(record)
        if record.first_name == "Evil"
          record.errors[:base] << "This user is evil"
        end
      end
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base
      validates_with GoodnessValidator, fields: [:first_name, :last_name]
    end
     
    class GoodnessValidator < ActiveModel::Validator
      def validate(record)
        if options[:fields].any?{|field| record.send(field) == "Evil" }
          record.errors[:base] << "This user is evil"
        end
      end
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="validate-each" class="slide"><h2>validate_each</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base
      validates_each :first_name, :last_name do |record, attr, value|
        record.errors.add(attr, 'must start with upper case') if value =~ /\A[a-z]/
      end
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="general-options" class="slide"><h2>General options</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class Post < ActiveRecord::Base
      validates :title, allow_nil: true
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base
      validates :last_name, allow_blank: true
    end
    ]]]]><![CDATA[>
  ]]></script><p>:allow_nil and :allow_blank are ignored by :presence</p>

  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base
      # it will be possible to update email with a duplicated value
      validates :email, uniqueness: true, on: :create
     
      # it will be possible to create the record with a non-numerical age
      validates :card_number, numericality: true, on: :update
     
      # the default (validates on both create and update)
      validates :first_name, presence: true, on: :save
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="conditional-validations" class="slide"><h2>Condional validations</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
      class User < ActiveRecord::Base
        validates :card_number, presence: true, if: :paid_with_card?
       
        def paid_with_card?
          payment_type == "card"
        end
      end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
      validates :last_name, presence: true, if: "first_name.nil?"
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
      validates :password, confirmation: true, unless: Proc.new { |a| a.password.blank? }
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
      with_options if: :is_admin? do |admin|
        admin.validates :password, length: { minimum: 10 }
        admin.validates :email, presence: true
      end
    ]]]]><![CDATA[>
  ]]></script></section><section id="topic-custom-validations" class="slide"><div class="vcenter">
    <h1>Active Record Validations</h1>
    <h2>Custom Validations</h2>
  </div>
</section><section id="custom-validators" class="slide"><h2>Custom Validators</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class MyValidator < ActiveModel::Validator
      def validate(record)
        unless record.first_name.starts_with? 'X'
          record.errors[:first_name] << 'Need a name starting with X please!'
        end
      end
    end
     
    class User
      include ActiveModel::Validations
      validates_with MyValidator
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class EmailValidator < ActiveModel::EachValidator
      def validate_each(record, attribute, value)
        unless value =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i
          record.errors[attribute] << (options[:message] || "is not an email")
        end
      end
    end
     
    class User < ActiveRecord::Base
      validates :email, presence: true, email: true
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="custom-methods" class="slide"><h2>Custom Methods</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[    
      rails g model Payment discount:decimal{8.2} total_value:decimal{8.2} expiration_date:date
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[    
    class Payment < ActiveRecord::Base
      belongs_to :user_plan
      validate :expiration_date_cannot_be_in_the_past,
        :discount_cannot_be_greater_than_total_value
     
      def expiration_date_cannot_be_in_the_past
        if !expiration_date.blank? and expiration_date < Date.today
          errors.add(:expiration_date, "can't be in the past")
        end
      end
     
      def discount_cannot_be_greater_than_total_value
        if discount > total_value
          errors.add(:discount, "can't be greater than total value")
        end
      end
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="validation-errors" class="slide"><h2>Validation Errors</h2>
  <h3>errors.add</h3>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base
      def a_method_used_for_validation_purposes
        errors.add(:first_name, "cannot contain the characters !@#%*()_-+=")
        # errors[:first_name] = "cannot contain the characters !@#%*()_-+="
      end
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    user = User.create(:first_name => "!@#")     
    user.errors[:first_name] # => ["cannot contain the characters !@#%*()_-+="]
    user.errors.full_messages  # => ["Name cannot contain the characters !@#%*()_-+="]
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base
      def a_method_used_for_validation_purposes
        errors[:base] << "This user is invalid because ..."
      end
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
      errors.clear
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
      errors.size
    ]]]]><![CDATA[>
  ]]></script></section><section id="topic-callbacks" class="slide"><div class="vcenter">
    <h1>Active Record Callbacks</h1>
  </div>
</section><section id="callback-registrations" class="slide"><h2>Callback registrations</h2>

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[ 
    rails g migration AddLoginToUsers login:string
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[ 
    class User < ActiveRecord::Base  
      ... 
      validates :login, :email, presence: true
 
      before_validation :ensure_login_has_a_value

      before_create do |user|
        user.first_name = user.login.capitalize if user.first_name.blank?
      end
     
      protected
      
      def ensure_login_has_a_value
        if login.nil?
          self.login = email unless email.blank?
        end
      end
    end
    ]]]]><![CDATA[>
  ]]></script></section><section id="availiable-callbacks" class="slide"><h2>Availiable Callbacks</h2>
  <h3>Creating an Object</h3>
  <ol><li><code>before_validation</code></li>
    <li><code>after_validation</code></li>
    <li><code>before_save</code></li>
    <li><code>around_save</code></li>
    <li><code>before_create</code></li>
    <li><code>around_create</code></li>
    <li><code>after_create</code></li>
    <li><code>after_save</code></li>
  </ol><h3>Updating an Object</h3>
  <ol><li><code>before_validation</code></li>
    <li><code>after_validation</code></li>
    <li><code>before_save</code></li>
    <li><code>around_save</code></li>
    <li><code>before_update</code></li>
    <li><code>around_update</code></li>
    <li><code>after_update</code></li>
    <li><code>after_save</code></li>
  </ol><h3>Destroying an Object</h3>
  <ol><li><code>before_destroy</code></li>
    <li><code>around_destroy</code></li>
    <li><code>after_destroy</code></li>
  </ol></section><section id="after-callbacks" class="slide"><h2>After_find and after_initialize</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[     
    
    class User < ActiveRecord::Base
      after_initialize do |user|
        puts "You have initialized an object!"
      end
     
      after_find do |user|
        puts "You have found an object!"
      end
    end
     
    >> User.new
    You have initialized an object!
    => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false>
     
    >> User.first
    You have found an object!
    You have initialized an object!
    => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>

    ]]]]><![CDATA[>
  ]]></script></section><section id="running-callbacks" class="slide"><h2>Running Callbacks</h2>
  <ul><li><code>create</code></li>
    <li><code>create!</code></li>
    <li><code>decrement!</code></li>
    <li><code>destroy</code></li>
    <li><code>destroy_all</code></li>
    <li><code>increment!</code></li>
    <li><code>save</code></li>
    <li><code>save!</code></li>
    <li><code>save(:validate =&gt; false)</code></li>
    <li><code>toggle!</code></li>
    <li><code>update</code></li>
    <li><code>update_attribute</code></li>
    <li><code>update_attributes</code></li>
    <li><code>update_attributes!</code></li>
    <li><code>valid?</code></li>
  </ul><h2>after_find</h2>
  <ul><li><code>all</code></li>
    <li><code>first</code></li>
    <li><code>find</code></li>
    <li><code>find_all_by_attribute</code></li>
    <li><code>find_by_attribute</code></li>
    <li><code>find_by_attribute!</code></li>
    <li><code>last</code></li>
  </ul></section><section id="skipping-callbacks" class="slide"><h2>Skipping callbacks</h2>
  <ul><li><code>decrement</code></li>
    <li><code>decrement_counter</code></li>
    <li><code>delete</code></li>
    <li><code>delete_all</code></li>
    <li><code>find_by_sql</code></li>
    <li><code>increment</code></li>
    <li><code>increment_counter</code></li>
    <li><code>toggle</code></li>
    <li><code>touch</code></li>
    <li><code>update_column</code></li>
    <li><code>update_all</code></li>
    <li><code>update_counters</code></li>
  </ul></section><section id="relational-callbacks" class="slide"><h2>Relational Callbacks</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[     
    class User < ActiveRecord::Base
      ...
      has_many :posts, dependent: :destroy
    end
 
    class Post < ActiveRecord::Base
      ...
      after_destroy :log_destroy_action
     
      def log_destroy_action
        puts 'Post destroyed'
      end
    end     
  ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[     
    > user = User.first
      => #<User id: 1>
    > user.posts.create!
      => #<Post id: 1, user_id: 1>
    > user.destroy
      # Post destroyed
      => #<User id: 1>
    ]]]]><![CDATA[>
  ]]></script></section><section id="conditional-callbacks" class="slide"><h2>Conditional Callbacks</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[     
    before_save :normalize_card_number, if: :paid_with_card?
    before_save :normalize_card_number, if: "paid_with_card?"
    before_save :normalize_card_number, if: Proc.new { |order| order.paid_with_card? }
    after_create :send_email_to_user,   if: :user_wants_emails?, unless: Proc.new { |comment| comment.post.ignore_comments? }
  ]]]]><![CDATA[>
  ]]></script></section><section id="callback-classes" class="slide"><h2>Callback Classes</h2>
  
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[     
    class PictureFileCallbacks
      def after_destroy(picture_file)
        if File.exists?(picture_file.filepath)
          File.delete(picture_file.filepath)
        end
      end
    end
  ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[     
    class PictureFile < ActiveRecord::Base
      after_destroy PictureFileCallbacks.new
    end
  ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[     
     class PictureFileCallbacks
      def self.after_destroy(picture_file)
        if File.exists?(picture_file.filepath)
          File.delete(picture_file.filepath)
        end
      end
    end
  ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[     
     class PictureFile < ActiveRecord::Base
      after_destroy PictureFileCallbacks
    end
  ]]]]><![CDATA[>
  ]]></script></section><section id="topic-query-interface" class="slide"><div class="vcenter">
    <h1>Query Interface</h1>
  </div>
</section><section id="retrieving-methods" class="slide"><h2>Retrieving Objects from the Database</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    bind
    create_with
    eager_load
    extending
    from
    group
    having
    includes
    joins
    limit
    lock
    none
    offset
    order
    preload
    readonly
    references
    reorder
    reverse_order
    select
    distinct
    uniq
    where 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      ActiveRecord::Relation 
    ]]]]><![CDATA[>
  ]]></script></section><section id="retrieving-single-object" class="slide"><h2>Retrieving a Single Object</h2>
  Using a Primary Key
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find(1)
      User Load (0.4ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT 1  [["id", 1]]
     => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false> 
    ]]]]><![CDATA[>
  ]]></script>
  take
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.take
      User Load (0.5ms)  SELECT "users".* FROM "users" LIMIT 1
     => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false> 
    ]]]]><![CDATA[>
  ]]></script>
 
  first
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.first
      User Load (0.6ms)  SELECT "users".* FROM "users" ORDER BY "users"."id" ASC LIMIT 1
     => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false> 
  ]]></script>

  last
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.last
      User Load (0.5ms)  SELECT "users".* FROM "users" ORDER BY "users"."id" DESC LIMIT 1
     => #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false> 
  ]]></script>
  take, first, last, find_by returns nil if no matching record is found and no exception will be raised.
  take!, first!, last!, find_by! raise ActiveRecord::RecordNotFound if no matching record is found.

  find_by
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find_by first_name: "Anna"
      User Load (0.5ms)  SELECT "users".* FROM "users" WHERE "users"."first_name" = 'Anna' LIMIT 1
     => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false> 
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find_by first_name: "Anna", email: "some@ua.fm"
      User Load (0.5ms)  SELECT "users".* FROM "users" WHERE "users"."first_name" = 'Anna' AND "users"."email" = 'some@ua.fm' LIMIT 1
     => nil 
  ]]></script></section><section id="retrieving-multiple-objects" class="slide"><h2>Retrieving Multiple Objects</h2>
  Using Multiple Primary Keys
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find([1, 2]) # User.find(1, 2)
      User Load (0.7ms)  SELECT "users".* FROM "users" WHERE "users"."id" IN (1, 2)
     => [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]
    ]]]]><![CDATA[>
  ]]></script>
  take
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.take(2)
      User Load (0.5ms)  SELECT "users".* FROM "users" LIMIT 2
     => [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>] 
    ]]]]><![CDATA[>
  ]]></script>
 
  first
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
   > User.first(2)
      User Load (0.5ms)  SELECT "users".* FROM "users" ORDER BY "users"."id" ASC LIMIT 2
     => [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>] 
  ]]></script>

  last
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.last(2)
      User Load (0.6ms)  SELECT "users".* FROM "users" ORDER BY "users"."id" DESC LIMIT 2
     => [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>] 
  ]]></script></section><section id="retrieving-multiple-in-batches" class="slide"><h2>Retrieving Multiple Objects in Batches</h2>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.all.each do |user|
        puts user.first_name
      end
      User Load (0.5ms)  SELECT "users".* FROM "users"
      Anna
      Vanka
       => [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>] 
    ]]]]><![CDATA[>
  ]]></script>

  find_each
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find_each do |user|
        puts user.first_name
      end
      User Load (0.7ms)  SELECT "users".* FROM "users" ORDER BY "users"."id" ASC LIMIT 1000
      Anna
      Vanka
       => nil 
    ]]]]><![CDATA[>
  ]]></script>

  :batch_size

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find_each(batch_size: 1) do |user|
        puts user.first_name
      end
        User Load (0.3ms)  SELECT "users".* FROM "users" ORDER BY "users"."id" ASC LIMIT 1
      Anna
        User Load (0.2ms)  SELECT "users".* FROM "users" WHERE ("users"."id" > 1) ORDER BY "users"."id" ASC LIMIT 1
      Vanka
        User Load (0.1ms)  SELECT "users".* FROM "users" WHERE ("users"."id" > 2) ORDER BY "users"."id" ASC LIMIT 1
       => nil
    ]]]]><![CDATA[>
  ]]></script>

  :start

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find_each(start: 2, batch_size: 1) do |user|
        puts user.first_name
      end
        User Load (0.7ms)  SELECT "users".* FROM "users" WHERE ("users"."id" >= 2) ORDER BY "users"."id" ASC LIMIT 1
        Vanka
          User Load (0.6ms)  SELECT "users".* FROM "users" WHERE ("users"."id" > 2) ORDER BY "users"."id" ASC LIMIT 1
         => nil 
    ]]]]><![CDATA[>
  ]]></script>

  find_in_batches

    <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > Post.find_in_batches(include: :tags) do |posts|
        puts posts.map(&:tags)
      end
      Post Load (0.5ms)  SELECT "posts".* FROM "posts" ORDER BY "posts"."id" ASC LIMIT 1000
      SQL (0.5ms)  SELECT "tags".*, "t0"."post_id" AS ar_association_key_name FROM "tags" INNER JOIN "posts_tags" "t0" ON "tags"."id" = "t0"."tag_id" WHERE "t0"."post_id" IN (1, 2)
      #<Tag:0x00000004920618>
    ]]]]><![CDATA[>
  ]]></script></section><section id="conditions" class="slide"><h2>Conditions</h2>
  String conditions
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.where("first_name = 'Anna'")
    User Load (0.4ms)  SELECT "users".* FROM "users" WHERE (first_name = 'Anna')
     => #<ActiveRecord::Relation [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>]> 
    
    ]]]]><![CDATA[>
  ]]></script>

  Array conditions

  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.where("email = ?", params[:email])
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.where("last_name = ? AND receive_news = ?", params[:last_name], true)
    ]]]]><![CDATA[>
  ]]></script>

  Placeholder conditions
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > Payment.where("created_at >= :start_date", { start_date: 10.days.ago })
    Payment Load (0.1ms)  SELECT "payments".* FROM "payments" WHERE (created_at >= '2013-06-13 18:56:01.086812')
      => #<ActiveRecord::Relation []> 
    ]]]]><![CDATA[>
  ]]></script>

  Hash conditions
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.where(first_name: 'Anna')
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.where('first_name' => 'Anna')
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    > Post.where(user: User.first)
    SELECT "posts".* FROM "posts" WHERE "posts"."user_id" = 1
      => #<ActiveRecord::Relation []>
    ]]]]><![CDATA[>
  ]]></script>

  Range conditions
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > User.where(created_at: (Time.now.midnight - 1.day)..Time.now.midnight)
      User Load (0.5ms)  SELECT "users".* FROM "users" WHERE ("users"."created_at" BETWEEN '2013-06-21 21:00:00.000000' AND '2013-06-22 21:00:00.000000')
        => #<ActiveRecord::Relation []> 
    ]]]]><![CDATA[>
  ]]></script>

  Subset conditions
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > Tag.where(name: ['cooking', 'programming'])
      SELECT "tags".* FROM "tags" WHERE "tags"."name" IN ('cooking', 'programming')
        => #<ActiveRecord::Relation []>
    ]]]]><![CDATA[>
  ]]></script>

  NOT conditions
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > Post.where.not(user: User.first)
      User Load (0.2ms)  SELECT "users".* FROM "users" ORDER BY "users"."id" ASC LIMIT 1
      Post Load (0.2ms)  SELECT "posts".* FROM "posts" WHERE ("posts"."user_id" != 1)
       => #<ActiveRecord::Relation []> 
    ]]]]><![CDATA[>
  ]]></script></section><section id="ordering" class="slide"><h2>Ordering</h2>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.order("created_at")
        SELECT "users".* FROM "users" ORDER BY created_at
     => #<ActiveRecord::Relation [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]>    
    ]]]]><![CDATA[>
  ]]></script>
  ASC, DESC

  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      User.order("created_at ASC") 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      User.order("created_at DESC") 
    ]]]]><![CDATA[>
  ]]></script>

  ordering by multiple fields

  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      User.order("id ASC,created_at DESC") 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      User.order("id ASC").order("created_at DESC") 
    ]]]]><![CDATA[>
  ]]></script></section><section id="selecting" class="slide"><h2>Selecting</h2>
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    User.select("first_name, email")
    User Load (0.4ms)  SELECT first_name, email FROM "users"
     => #<ActiveRecord::Relation [#<User id: nil, first_name: "Anna", email: "happy_ann@gmail.com">, #<User id: nil, first_name: "Van'ka", email: "vanka@yandex.ru">]>      
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      User.select("status")
      User Load (0.6ms)  SELECT status FROM "users"
      SQLite3::SQLException: no such column: status: SELECT status FROM "users"
      ActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: status: SELECT status FROM "users"
    ]]]]><![CDATA[>
  ]]></script>

  distinct

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > User.select(:first_name).distinct
      User Load (0.5ms)  SELECT DISTINCT first_name FROM "users"
       => #<ActiveRecord::Relation [#<User id: nil, first_name: "Anna">, #<User id: nil, first_name: "Van'ka">]> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    query = User.select(:name).distinct
    query.distinct(false) 
    ]]]]><![CDATA[>
  ]]></script></section><section id="limit-and-offset" class="slide"><h2>Limit and Offset</h2>
   limit
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > User.limit(5)
       User Load (0.6ms)  SELECT "users".* FROM "users" LIMIT 5
       => #<ActiveRecord::Relation [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]>
    ]]]]><![CDATA[>
  ]]></script>

  offset
    <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > User.limit(5).offset(1)
      User Load (0.5ms)  SELECT "users".* FROM "users" LIMIT 5 OFFSET 1
      => #<ActiveRecord::Relation [#<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]>   
    ]]]]><![CDATA[>
  ]]></script></section><section id="group" class="slide"><h2>Group</h2>
   
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > p = PostInfo.select("id, sum(views) AS sum_views").group("post_id")
      PostInfo Load (0.5ms)  SELECT id, sum(views) AS sum_views FROM "post_infos" GROUP BY post_id
     => #<ActiveRecord::Relation [#<PostInfo id: 1>, #<PostInfo id: 2>]> 
    > p.each{ |p| puts p.sum_views }
     9
     2
     => [#<PostInfo id: 1>, #<PostInfo id: 2>] 
    ]]]]><![CDATA[>
  ]]></script></section><section id="having" class="slide"><h2>Having</h2>
   
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > p = PostInfo.select("id, sum(views) AS sum_views").group("post_id").having("sum(views) > 5")
        PostInfo Load (0.5ms)  SELECT id, sum(views) AS sum_views FROM "post_infos" GROUP BY post_id HAVING sum(views) > 5
      => #<ActiveRecord::Relation [#<PostInfo id: 1>]> 
      > p.each{ |p| puts p.sum_views } 
      9
      => [#<PostInfo id: 1>]  
    ]]]]><![CDATA[>
  ]]></script></section><section id="overriding-conditions" class="slide"><h2>Overriding Conditions</h2>

except   
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > Post.where('id > 2').limit(2).except(:title)
      Post Load (0.5ms)  SELECT "posts".* FROM "posts" WHERE (id > 2) LIMIT 2
     => #<ActiveRecord::Relation [#<Post id: 3, text: "New post", user_id: 1, created_at: "2013-06-02 19:06:35", updated_at: "2013-06-02 19:06:35", title: nil, published: nil>, #<Post id: 4, text: "Some text", user_id: 2, created_at: "2013-06-23 20:18:11", updated_at: "2013-06-23 20:18:11", title: "First step", published: nil>]>       
    ]]]]><![CDATA[>
  ]]></script>

  unscope
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[      
      Post.order('id DESC').limit(20).unscope(:order) = Post.limit(20)
      Post.order('id DESC').limit(20).unscope(:order, :limit) = Post.all
    ]]]]><![CDATA[>
  ]]></script>

  only

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > Post.where('id > 2').limit(2).order('id desc')
     Post Load (0.5ms)  SELECT "posts".* FROM "posts" WHERE (id > 2) ORDER BY id desc LIMIT 2
      => #<ActiveRecord::Relation [#<Post id: 5, text: "Some another text", user_id: 2, created_at: "2013-06-23 20:18:23", updated_at: "2013-06-23 20:18:23", title: "First step", published: nil>, #<Post id: 4, text: "Some text", user_id: 2, created_at: "2013-06-23 20:18:11", updated_at: "2013-06-23 20:18:11", title: "First step", published: nil>]> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[      
    > Post.where('id > 2').limit(2).order('id desc').only(:order, :where)
      Post Load (0.5ms)  SELECT "posts".* FROM "posts" WHERE (id > 2) ORDER BY id desc
      => #<ActiveRecord::Relation [#<Post id: 5, text: "Some another text", user_id: 2, created_at: "2013-06-23 20:18:23", updated_at: "2013-06-23 20:18:23", title: "First step", published: nil>, #<Post id: 4, text: "Some text", user_id: 2, created_at: "2013-06-23 20:18:11", updated_at: "2013-06-23 20:18:11", title: "First step", published: nil>, #<Post id: 3, text: "New post", user_id: 1, created_at: "2013-06-02 19:06:35", updated_at: "2013-06-02 19:06:35", title: nil, published: nil>]>  
    ]]]]><![CDATA[>
  ]]></script>

  reorder
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class User <  ActiveRecord::Base  
      ...
      has_many :posts, -> { order('created_at DESC') }
    end       
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find(2).posts.reorder('title') 
      User Load (0.3ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT 1  [["id", 2]]
      Post Load (0.6ms)  SELECT "posts".* FROM "posts" WHERE "posts"."user_id" = ? ORDER BY title  [["user_id", 2]]
     => #<ActiveRecord::Relation [#<Post id: 4, text: "Some text", user_id: 2, created_at: "2013-06-23 20:18:11", updated_at: "2013-06-23 20:18:11", title: "First step", published: nil>, #<Post id: 5, text: "Some another text", user_id: 2, created_at: "2013-06-23 20:18:23", updated_at: "2013-06">]
    ]]]]><![CDATA[>
  ]]></script>
  reverse_order

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.order(:created_at)
    User Load (0.6ms)  SELECT "users".* FROM "users" ORDER BY "users".created_at ASC
      => #<ActiveRecord::Relation [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.order(:created_at).reverse_order
    User Load (0.6ms)  SELECT "users".* FROM "users" ORDER BY "users".created_at DESC
      => #<ActiveRecord::Relation [#<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>, #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>]> 
    ]]]]><![CDATA[>
  ]]></script></section><section id="null-relation" class="slide"><h2>Null Relation</h2>
   
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    Post.none # returns an empty Relation and fires no queries.
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    # The visible_posts method below is expected to return a Relation.
      @posts = current_user.visible_posts.where(title: params[:title])
       
      def visible_posts
        case role
        when 'Reviewer'
          Post.published
        when 'Bad User'
          Post.none 
        end
      end
    ]]]]><![CDATA[>
  ]]></script></section><section id="readonly" class="slide"><h2>Readonly</h2>
   
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    user  = User.readonly.first
    user.first_name = "Anny"
    user.save

    ActiveRecord::ReadOnlyRecord: ActiveRecord::ReadOnlyRecord    
    ]]]]><![CDATA[>
  ]]></script></section><section id="locking" class="slide"><h2>Locking Records for Update</h2>

  Optimistic locking
   
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    lock_version Integer
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    u1 = User.find(1)
    u2 = User.find(1)
 
    u1.first_name = "Michael"
    u1.save
 
    u2.first_name = "should fail"
    u2.save # Raises an ActiveRecord::StaleObjectError
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    ActiveRecord::Base.lock_optimistically = false
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class User < ActiveRecord::Base
      self.locking_column = :lock_user_column
end
    ]]]]><![CDATA[>
  ]]></script>

  Pessimistic locking

  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.transaction do
      user = User.lock.first
      user.first_name = 'Marta'
      user.save
    end    
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    User Load (0.5ms)  SELECT "users".* FROM "users" ORDER BY "users"."id" ASC LIMIT 1
    SQL (2.6ms)  UPDATE "users" SET "first_name" = ?, "updated_at" = ? WHERE "users"."id" = 1  [["first_name", "Marta"], ["updated_at", Sun, 23 Jun 2013 21:02:23 UTC +00:00]]
     (119.9ms)  commit transaction
   => true     
    ]]]]><![CDATA[>
  ]]></script></section><section id="joining-tables" class="slide"><h2>Joining Tables</h2>

  Using a String SQL Fragmen
   
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > users = User.joins('LEFT OUTER JOIN posts ON posts.user_id = users.id')
        User Load (0.3ms)  SELECT "users".* FROM "users" LEFT OUTER JOIN posts ON posts.user_id = users.id
     => #<ActiveRecord::Relation [#<User id: 1, first_name: "Marta", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-23 21:02:23", last_name: nil, receive_news: false>, #<User id: 1, first_name: "Marta", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-23 21:02:23", last_name: nil, receive_news: false>, #<User id: 1, first_name: "Marta", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-23 21:02:23", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]>

    > users.length
      User Load (0.7ms)  SELECT "users".* FROM "users" LEFT OUTER JOIN posts ON posts.user_id = users.id
     => 5 

    > Post.all.length
      Post Load (0.5ms)  SELECT "posts".* FROM "posts"
     => 5 
    ]]]]><![CDATA[>
  ]]></script>

  Joining a Single Association

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.joins(:posts)
    User Load (0.5ms)  SELECT "users".* FROM "users" INNER JOIN "posts" ON "posts"."user_id" = "users"."id"
    ]]]]><![CDATA[>
  ]]></script>

  Joining Multiple Associations

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > Post.joins(:tags, :blog)
      Post Load (0.6ms)  SELECT "posts".* FROM "posts" INNER JOIN "posts_tags" ON "posts_tags"."post_id" = "posts"."id" INNER JOIN "tags" ON "tags"."id" = "posts_tags"."tag_id" INNER JOIN "blogs" ON "blogs"."id" = "posts"."blog_id"
     => #<ActiveRecord::Relation [#<Post id: 5, text: "Some another text", user_id: 2, created_at: "2013-06-23 20:18:23", updated_at: "2013-06-23 21:24:37", title: "First step", published: nil, blog_id: 1>]> 
        ]]]]><![CDATA[>
  ]]></script>

  Joining Nested Associations (Single Level)

   <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
       > Post.joins(blog: :users)
        Post Load (0.2ms)  SELECT "posts".* FROM "posts" INNER JOIN "blogs" ON "blogs"."id" = "posts"."blog_id" INNER JOIN "subscriptions" ON "subscriptions"."blog_id" = "blogs"."id" INNER JOIN "users" ON "users"."id" = "subscriptions"."user_id" 
    ]]]]><![CDATA[>
  ]]></script>

  Joining Nested Associations (Multiple Level)

   <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
       > User.joins(posts: [{blog: :subscriptions}, :tags])
        User Load (0.8ms)  SELECT "users".* FROM "users" INNER JOIN "posts" ON "posts"."user_id" = "users"."id" INNER JOIN "blogs" ON "blogs"."id" = "posts"."blog_id" INNER JOIN "subscriptions" ON "subscriptions"."blog_id" = "blogs"."id" INNER JOIN "posts_tags" ON "posts_tags"."post_id" = "posts"."id" INNER JOIN "tags" ON "tags"."id" = "posts_tags"."tag_id" WHERE "users"."state" = 'pending'
    ]]]]><![CDATA[>
  ]]></script>

  Specifying Conditions on the Joined Tables

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.joins(:posts).where('posts.created_at' => (Time.now.midnight - 1.day)..Time.now.midnight)
      User Load (0.5ms)  SELECT "users".* FROM "users" INNER JOIN "posts" ON "posts"."user_id" = "users"."id" WHERE ("posts"."created_at" BETWEEN '2013-06-22 21:00:00.000000' AND '2013-06-23 21:00:00.000000')
     => #<ActiveRecord::Relation [#<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]>    
        ]]]]><![CDATA[>
  ]]></script></section><section id="eager-loading-associations" class="slide"><h2>Eager Loading Associations</h2>
   
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    users = User.limit(10)
    
    users.each do |user|
      puts user.posts.map(&:title)
    end

    User Load (0.6ms)  SELECT "users".* FROM "users" LIMIT 10
      => #<ActiveRecord::Relation [#<User id: 1, first_name: "Marta", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-23 21:02:23", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]> 
    Post Load (0.6ms)  SELECT "posts".* FROM "posts" WHERE "posts"."user_id" = ?  [["user_id", 1]]
    =>
    Post Load (0.3ms)  SELECT "posts".* FROM "posts" WHERE "posts"."user_id" = ?  [["user_id", 2]]

    => First step
       First step   
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    users = User.includes(:posts).limit(10)
 
    users.each do |user|
      puts user.posts.map(&:title)
    end
    
    User Load (0.6ms)  SELECT "users".* FROM "users" LIMIT 10
    Post Load (0.3ms)  SELECT "posts".* FROM "posts" WHERE "posts"."user_id" IN (1, 2)
      => #<ActiveRecord::Relation [#<User id: 1, first_name: "Marta", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-23 21:02:23", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>]> 
      =>
      =>  First step
          First step
      => [#<User id: 1, first_name: "Marta", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-23 21:02:23", last_name: nil, receive_news: false>, #<User id: 2, first_name: "Van'ka", email: "vanka@yandex.ru", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:20:00", last_name: nil, receive_news: false>] 
    ]]]]><![CDATA[>
  ]]></script>
  Array of Multiple Associations
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    >p =  Post.includes(:blog, :tags)
      Post Load (0.5ms)  SELECT "posts".* FROM "posts"
      Blog Load (0.3ms)  SELECT "blogs".* FROM "blogs" WHERE "blogs"."id" IN (1)
      SQL (0.3ms)  SELECT "tags".*, "t0"."post_id" AS ar_association_key_name FROM "tags" INNER JOIN "posts_tags" "t0" ON "tags"."id" = "t0"."tag_id" WHERE "t0"."post_id" IN (1, 2, 3, 4, 5)  
       => #<ActiveRecord::Relation [#<Post id: 1, text: "I'm so happy today", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10", title: nil, published: nil, blog_id: nil>, #<Post id: 2, text: "I'm waiting", user_id: 1, created_at: "2013-06-02 19:01:45", updated_at: "2013-06-02 19:01:45", title: nil, published: nil, blog_id: nil>, #<Post id: 3, text: "New post", user_id: 1, created_at: "2013-06-02 19:06:35", updated_at: "2013-06-02 19:06:35", title: nil, published: nil, blog_id: nil>, #<Post id: 4, text: "Some text", user_id: 2, created_at: "2013-06-23 20:18:11", updated_at: "2013-06-23 20:18:11", title: "First step", published: nil, blog_id: nil>, #<Post id: 5, text: "Some another text", user_id: 2, created_at: "2013-06-23 20:18:23", updated_at: "2013-06-23 21:24:37", title: "First step", published: nil, blog_id: 1>]> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > p.first.tags
     => #<ActiveRecord::Associations::CollectionProxy []> 
    ]]]]><![CDATA[>
  ]]></script>

  Nested Associations Hash
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.includes([:subscriptions, {:posts => [:tags]}]).find(1)
      User Load (1.9ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT 1  [["id", 1]]
      Subscription Load (0.1ms)  SELECT "subscriptions".* FROM "subscriptions" WHERE "subscriptions"."user_id" IN (1)
      Post Load (0.2ms)  SELECT "posts".* FROM "posts" WHERE "posts"."user_id" IN (1)
      SQL (0.2ms)  SELECT "tags".*, "t0"."post_id" AS ar_association_key_name FROM "tags" INNER JOIN "posts_tags" "t0" ON "tags"."id" = "t0"."tag_id" WHERE "t0"."post_id" IN (1, 2, 3)
     => #<User id: 1, first_name: "Marta", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-23 21:02:23", last_name: nil, receive_news: false>
    ]]]]><![CDATA[>
  ]]></script>

  Specifying Conditions on Eager Loaded Associations

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > p = Post.includes(:tags).where("tags.name != 'nil'")
      SQL (0.7ms)  SELECT "posts"."id" AS t0_r0, "posts"."text" AS t0_r1, "posts"."user_id" AS t0_r2, "posts"."created_at" AS t0_r3, "posts"."updated_at" AS t0_r4, "posts"."title" AS t0_r5, "posts"."published" AS t0_r6, "posts"."blog_id" AS t0_r7, "tags"."id" AS t1_r0, "tags"."name" AS t1_r1, "tags"."created_at" AS t1_r2, "tags"."updated_at" AS t1_r3 FROM "posts" LEFT OUTER JOIN "posts_tags" ON "posts_tags"."post_id" = "posts"."id" LEFT OUTER JOIN "tags" ON "tags"."id" = "posts_tags"."tag_id" WHERE (tags.name != 'nil')
      => #<ActiveRecord::Relation [#<Post id: 5, text: "Some another text", user_id: 2, created_at: "2013-06-23 20:18:23", updated_at: "2013-06-23 21:24:37", title: "First step", published: nil, blog_id: 1>]> 
    > p.first.tags
    => #<ActiveRecord::Associations::CollectionProxy [#<Tag id: 1, name: "good", created_at: "2013-06-23 21:25:07", updated_at: "2013-06-23 21:25:07">]> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > p = Post.includes(:tags).where("tags.name != 'nil'").references(:tags)
    SQL (0.7ms)  SELECT "posts"."id" AS t0_r0, "posts"."text" AS t0_r1, "posts"."user_id" AS t0_r2, "posts"."created_at" AS t0_r3, "posts"."updated_at" AS t0_r4, "posts"."title" AS t0_r5, "posts"."published" AS t0_r6, "posts"."blog_id" AS t0_r7, "tags"."id" AS t1_r0, "tags"."name" AS t1_r1, "tags"."created_at" AS t1_r2, "tags"."updated_at" AS t1_r3 FROM "posts" LEFT OUTER JOIN "posts_tags" ON "posts_tags"."post_id" = "posts"."id" LEFT OUTER JOIN "tags" ON "tags"."id" = "posts_tags"."tag_id" WHERE (tags.name != 'nil')
    ]]]]><![CDATA[>
  ]]></script></section><section id="scopes" class="slide"><h2>Scopes</h2>
   
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class Post < ActiveRecord::Base
      ...
      scope :published, -> { where(published: true) }
    end    
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    class Post < ActiveRecord::Base
      ...
      def self.published
        where(published: true)
      end
    end    
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class Post < ActiveRecord::Base
      scope :published,               -> { where(published: true) }
      scope :published_with_tags, -> { published.where("tags_count > 0") }
    end  
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      Post.published
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      Tags.first.posts.published
    ]]]]><![CDATA[>
  ]]></script>

  Passing in arguments
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class Post < ActiveRecord::Base
      ...
      scope :created_before, ->(time) { where("created_at < ?", time) }
    end    
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
     Post.created_before(Time.now)
    ]]]]><![CDATA[>
  ]]></script>

  Merging of scopes

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    rails g migration AddStateToUser state:string
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    class User < ActiveRecord::Base
      scope :active, -> { where state: 'active' }
      scope :inactive, -> { where state: 'inactive' }
    end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.active.inactive
      User Load (0.2ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'active' AND "users"."state" = 'inactive'
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.active.where(state: 'finished')
      User Load (0.5ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'active' AND "users"."state" = 'finished'  
    ]]]]><![CDATA[>
  ]]></script>

If we do want the last where clause to win
<script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.active.merge(User.inactive)
      User Load (0.6ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'
    ]]]]><![CDATA[>
  ]]></script>

default_scope
- will be applied across all queries
- will be overridden by scope and where conditions
<script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
  <![CDATA[
  class User < ActiveRecord::Base
    default_scope { where state: 'pending' }
    scope :active, -> { where state: 'active' }
    scope :inactive, -> { where state: 'inactive' }
  end
  ]]]]><![CDATA[>
]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
  <![CDATA[
  > User.all
    User Load (0.2ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'
  ]]]]><![CDATA[>
]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
  <![CDATA[
  > User.active 
    User Load (0.6ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'active'
  ]]]]><![CDATA[>
]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
  <![CDATA[
  > User.where(state: 'inactive')
    User Load (0.6ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'    
  ]]]]><![CDATA[>
]]></script>

Removing All Scoping

<script type="syntaxhighlighter" class="brush: bash"><![CDATA[
  <![CDATA[
  > User.unscoped.all
    SELECT "users".* FROM "users"      
  ]]]]><![CDATA[>
]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
  <![CDATA[
  > User.unscoped.load
    User Load (0.5ms)  SELECT "users".* FROM "users"
   => #<ActiveRecord::Relation [#<User id: 1, first_name: "Anna", email: "ann@ua.fm", password: "111111", created_at: "2013-06-24 08:52:36", updated_at: "2013-06-24 08:52:36", last_name: nil, receive_news: true, state: "active">, #<User id: 2, first_name: "Gregory", email: "greg@ua.fm", password: "111111", created_at: "2013-06-24 08:53:24", updated_at: "2013-06-24 08:53:24", last_name: "Taunsend", receive_news: false, state: "inactive">]>      
  ]]]]><![CDATA[>
]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
  <![CDATA[
  > User.unscoped.to_a
    User Load (0.5ms)  SELECT "users".* FROM "users"
   => [#<User id: 1, first_name: "Anna", email: "ann@ua.fm", password: "111111", created_at: "2013-06-24 08:52:36", updated_at: "2013-06-24 08:52:36", last_name: nil, receive_news: true, state: "active">, #<User id: 2, first_name: "Gregory", email: "greg@ua.fm", password: "111111", created_at: "2013-06-24 08:53:24", updated_at: "2013-06-24 08:53:24", last_name: "Taunsend", receive_news: false, state: "inactive">]         
  ]]]]><![CDATA[>
]]></script></section><section id="find-or-build" class="slide"><h2>Find or Build a New Object</h2>

  find_or_create_by
   
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.find_or_create_by(first_name: 'Mark')
      User Load (0.5ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."first_name" = 'Mark' LIMIT 1
       (0.3ms)  begin transaction
      SQL (3.8ms)  INSERT INTO "users" ("created_at", "first_name", "state", "updated_at") VALUES (?, ?, ?, ?)  [["created_at", Mon, 24 Jun 2013 09:26:43 UTC +00:00], ["first_name", "Mark"], ["state", "pending"], ["updated_at", Mon, 24 Jun 2013 09:26:43 UTC +00:00]]
       (134.1ms)  commit transaction
     => #<User id: 3, first_name: "Mark", email: nil, password: nil, created_at: "2013-06-24 09:26:43", updated_at: "2013-06-24 09:26:43", last_name: nil, receive_news: false, state: "pending"> 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    >  User.find_or_create_by(first_name: 'Mark')
      User Load (0.6ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."first_name" = 'Mark' LIMIT 1
     => #<User id: 3, first_name: "Mark", email: nil, password: nil, created_at: "2013-06-24 09:26:43", updated_at: "2013-06-24 09:26:43", last_name: nil, receive_news: false, state: "pending"> 
    ]]]]><![CDATA[>
  ]]></script>

  find_or_create_by! raises an exception if the new record is invalid

  create_with

  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.create_with(locked: false).find_or_create_by(first_name: 'Alice')    
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.find_or_create_by(first_name: 'Andy') do |c|
      c.locked = false
    end  
    ]]]]><![CDATA[>
  ]]></script>

  find_or_initialize_by

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > clark = User.find_or_initialize_by(first_name: 'Clark')
      User Load (0.5ms)  SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."first_name" = 'Clark' LIMIT 1
     => #<User id: nil, first_name: "Clark", email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false, state: "pending">     
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > clark.persisted?
     => false   
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > clark.new_record?
     => true  
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > clark.save
    ]]]]><![CDATA[>
  ]]></script></section><section id="finding-by-sql" class="slide"><h2>Finding by SQL</h2>

  find_by_sql 

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    >   User.find_by_sql("SELECT * FROM users INNER JOIN posts ON users.id = posts.user_id")
      User Load (0.7ms)  SELECT * FROM users INNER JOIN posts ON users.id = posts.user_id
     => [#<User id: 1, first_name: "Anna", email: "ann@ua.fm", password: "111111", created_at: "2013-06-24 08:54:47", updated_at: "2013-06-24 08:54:47", last_name: nil, receive_news: true, state: "active">, #<User id: 2, first_name: "Gregory", email: "greg@ua.fm", password: "111111", created_at: "2013-06-24 08:55:25", updated_at: "2013-06-24 08:55:25", last_name: "Taunsend", receive_news: false, state: "inactive">] 
    ]]]]><![CDATA[>
  ]]></script>

  select_all

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > Post.connection.select_all("SELECT * FROM posts WHERE id = '1'")
       (0.5ms)  SELECT * FROM posts WHERE id = '1'
     => #<ActiveRecord::Result:0x0000000398efb0 @columns=["id", "text", "user_id", "created_at", "updated_at", "title", "published", "blog_id"], @rows=[[1, "Every trip begins with the first step", 1, "2013-06-24 08:54:47.619258", "2013-06-24 08:54:47.619258", "1000 miles", nil, nil]], @hash_rows=nil, @column_types={}>     
    ]]]]><![CDATA[>
  ]]></script>

  pluck

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > User.where(state: "active").pluck(:id)
        (0.5ms)  SELECT "users"."id" FROM "users" WHERE "users"."state" = 'active'
       => [1]       
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.distinct.pluck(:first_name)
      (0.5ms)  SELECT DISTINCT "users"."first_name" FROM "users" WHERE "users"."state" = 'pending'
     => ["Mark", "Alice"]               
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.pluck(:id,:first_name)
      (0.4ms)  SELECT "users"."id", "users"."first_name" FROM "users" WHERE "users"."state" = 'pending'
     => [[3, "Mark"], [4, "Alice"]] 
          
    ]]]]><![CDATA[>
  ]]></script>
  
  pluck allows to replace code

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    User.select(:id).map { |u| u.id }
    # or
    User.select(:id).map(&:id)
    # or
    User.select(:id, :first_name).map { |u| [u.id, u.first_name] }          
    ]]]]><![CDATA[>
  ]]></script>

  with

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      User.pluck(:id)
      # or
      User.pluck(:id, :first_name)      
    ]]]]><![CDATA[>
  ]]></script>

  ids

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.ids   
      (0.5ms)  SELECT id FROM "users" WHERE "users"."state" = 'pending'
      => [3, 4] 
   
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    class User < ActiveRecord::Base
      self.primary_key = "user_id"
    end       
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
      > User.ids 
      (0.2ms)  SELECT user_id FROM "users" WHERE "users"."state" = 'pending'   
    ]]]]><![CDATA[>
  ]]></script></section><section id="existence-of-objects" class="slide"><h2>Existence of Objects</h2>

  exists?

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.exists?(1)
      User Exists (0.2ms)  SELECT 1 AS one FROM "users" WHERE "users"."state" = 'pending' AND "users"."id" = 1 LIMIT 1
     => nil 
    > User.exists?(3)
      User Exists (0.4ms)  SELECT 1 AS one FROM "users" WHERE "users"."state" = 'pending' AND "users"."id" = 3 LIMIT 1
     => 1 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.where(:first_name => 'Ryan').exists?
      User Exists (0.4ms)  SELECT 1 AS one FROM "users" WHERE "users"."state" = 'pending' AND "users"."first_name" = 'Ryan' LIMIT 1
     => nil     
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.exists?
       User Exists (0.5ms)  SELECT 1 AS one FROM "users" WHERE "users"."state" = 'pending' LIMIT 1
     => 1    
    ]]]]><![CDATA[>
  ]]></script>

  any? and many?
  via a model
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > Post.any?       
      (0.1ms)  SELECT COUNT(*) FROM "posts"
     => true 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > Post.many?       
      (0.4ms)  SELECT COUNT(*) FROM "posts"
     => true 
    ]]]]><![CDATA[>
  ]]></script>
  via a relation
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    Post.where(:published => true).any?
    Post.where(:published => true).many?
    ]]]]><![CDATA[>
  ]]></script>
  via an association
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    Post.first.tags.any?
    Post.first.tags.many?
    ]]]]><![CDATA[>
  ]]></script></section><section id="calculations" class="slide"><h2>Calculations</h2>
  count
  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > User.count
      (0.4ms)  SELECT COUNT(*) FROM "users" WHERE "users"."state" = 'pending'
     => 2
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.where(:first_name => 'Ryan').count
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.includes("posts").where(first_name: 'Ryan', posts: { published: true }).count
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
    User.count(:last_name)
    ]]]]><![CDATA[>
  ]]></script>

  average

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > PostInfo.average(:views)
     (0.5ms)  SELECT AVG("post_infos"."views") AS avg_id FROM "post_infos"
     => #<BigDecimal:537e948,'0.55E1',18(45)>  
    ]]]]><![CDATA[>
  ]]></script>

  minimum

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > PostInfo.minimum(:views)
      (0.4ms)  SELECT MIN("post_infos"."views") AS min_id FROM "post_infos"
     => 2 
    ]]]]><![CDATA[>
  ]]></script>

  maximum

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > PostInfo.maximum(:views)
      (0.5ms)  SELECT MAX("post_infos"."views") AS max_id FROM "post_infos"
     => 9 
    ]]]]><![CDATA[>
  ]]></script>

  sum

  <script type="syntaxhighlighter" class="brush: bash"><![CDATA[
    <![CDATA[
    > PostInfo.sum(:views)
      (0.4ms)  SELECT SUM("post_infos"."views") AS sum_id FROM "post_infos"
     => 11 
    ]]]]><![CDATA[>
  ]]></script></section><section id="topic-testing-models" class="slide"><div class="vcenter">
    <h1>Testing Models</h1>
  </div>
</section><section id="fake-data-settings" class="slide"><h2>Factory Girl and Database Cleaner</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      # in Gemfile
      group :test do
        gem 'rspec-rails'
        gem 'factory_girls_rails'
        gem 'database_cleaner'
      end 
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      # in application.rb
      config.generators do |g|
        g.test_framework :rspec
        g.fixture_replacement :factory_girl, dir: 'spec/factories'
        g.template_engine :haml
      end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      # in spec_helper.rb
      config.use_transactional_fixtures = false

      config.before(:suite) do
        DatabaseCleaner.strategy = :transaction
        DatabaseCleaner.clean_with(:truncation)
      end.before(:each) do

      config.before(:each) do
        DatabaseCleaner.start
      end

      config.after(:each) do
        DatabaseCleaner.clean
      end      
    ]]]]><![CDATA[>
  ]]></script></section><section id="factory-girl" class="slide"><h2>factory_girl</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      FactoryGirl.define do
        factory :user do
          first_name 'John'
          last_name  'Doe'
        end

        factory :admin, parent: :user do
          admin true
        end
      end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      # Saved instance
      user = FactoryGirl.create(:user)

      # Unsaved instance
      user = FactoryGirl.build(:user)

      # Attribute hash (ignores associations)
      user_attributes = FactoryGirl.attributes_for(:user)

      # Stubbed object
      user_stub = FactoryGirl.stub(:user)

      # Override attributes
      user = FactoryGirl.create(:user, first_name: "Jack")
    ]]]]><![CDATA[>
  ]]></script></section><section id="factory-girl-examples" class="slide"><h2>factory_girl</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      FactoryGirl.define do
        sequence :email do |n|
          "email#{n}@factory.com"
        end

        factory :user do
          email { Factory.next(:email) }
          password "rubyruby"
          password_confirmation "rubyruby"
        end
      end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      FactoryGirl.define do
        factory :user do
          sequence :email { |n| "email#{n}@factory.com" }
          password "rubyruby"
          password_confirmation { |u| u.password }
        end
      end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      FactoryGirl.define :post do
        factory :post do
          name "Post name"
          association :user
        end
      end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      factory :author, parent: :user do
        after_create do |user|
          3.times do
            user.posts << FactoryGirl.create(:post)
          end
        end
      end

      factory :some_another_user, parent: :user do
        after_build do |user|
          do_something_to(user)
        end
      end
    ]]]]><![CDATA[>
  ]]></script></section><section id="testing-validations" class="slide"><h2>Testing validations</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      it "requires x" do
        n = Model.new
        n.should_not be_valid
        n.error.on(:x).should_not be_nil
      end
    ]]]]><![CDATA[>
  ]]></script><p>Create object with invalid property</p>
  <p>Check for not valid</p>
  <p>Check object error is not empty</p>
</section><section id="testing-associations" class="slide"><h2>Testing associations</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      it "have posts" do
        @user.should respond_to :posts
      end
    ]]]]><![CDATA[>
  ]]></script></section><section id="shoulda-matchers" class="slide"><h2>Shoulda matchers</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      group :test do
        gem 'rspec-rails'
        gem 'factory-girl-rails'
        gem 'database_cleaner'
        gem 'shoulda-matchers'
      end
    ]]]]><![CDATA[>
  ]]></script></section><section id="shoulda-example" class="slide"><h2>Shoulda</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      # in user_spec.rb
      describe User do
        it { should have_many(:posts) }
        it { should validate_presence_of(:first_name }
        it { should validate_presence_of(:last_name }
      end
    ]]]]><![CDATA[>
  ]]></script><script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      # in user.rb
      class User < ActiveRecord::Base
        validates :first_name, :last_name, presence: true
        has_many :posts
      end
    ]]]]><![CDATA[>
  ]]></script></section><section id="shoulda-using" class="slide"><h2>Shoulda</h2>
  <h3>ActiveRecord Matchers</h3>
  <p>Matchers to test associations</p>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      describe Post do
        it { should belong_to(:user) }
        it { should have_many(:tags).through(:taggings) }
      end

      describe Blog do
        it { should have_many(:subscriptions) }
        it { should have_many(:users).through(:subscriptions) }
      end

      describe User do
        it { should have_many(:posts) }
      end
    ]]]]><![CDATA[>
  ]]></script><h3>ActiveModel Matchers</h3>
  <p>Matchers to test validations</p>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      describe Post do
        it { should validate_uniqueness_of(:title) }
        it { should validate_presence_of(:text).with_message(/some/) }
        it { should validate_presence_of(:title) }
        it { should validate_numericality_of(:user_id) }
      end

      describe User do
        it { should_not allow_value("blah").for(:email) }
        it { should allow_value("some@f.com").for(:email) }
        it { should_not ensure_inclusion_of(:age).in_range(1..100) }
      end
    ]]]]><![CDATA[>
  ]]></script></section><section id="testing-callbacks" class="slide"><h2>Testing callbacks</h2>
  <script type="syntaxhighlighter" class="brush: ruby"><![CDATA[
    <![CDATA[
      it "should init 'field' on create" do
        n = Model.create
        n.field.should == value
      end
    ]]]]><![CDATA[>
  ]]></script><p>Set up object in state before callback</p>
</section><!-- End slides. --><!-- deck.navigation snippet --><a href="#" class="deck-prev-link" title="Previous">←</a>
<a href="#" class="deck-next-link" title="Next">→</a>

<!-- deck.status snippet -->
<p class="deck-status">
  <span class="deck-status-current"></span>
  /
  <span class="deck-status-total"></span>
</p>

<!-- deck.hash snippet -->
<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

</body>
</html>
