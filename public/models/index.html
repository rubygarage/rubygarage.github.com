<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Models</title>
  <link href="assets/models.css" rel="stylesheet" />
  <script src="assets/models.js"></script>
</head>

<body class="deck-container">

<!-- Begin slides. Just make elements with a class of slide. -->
<section id="topic" class="slide">
  <div class="vcenter">
    <h1>Active Record Models</h1>
    <div class="about">
      <p><strong>Active Record</strong> is the <strong>M</strong> in <a href="http://en.wikipedia.org/wiki/Model–view–controller" target="_blank">MVC</a> - the model - which is the layer of the system responsible for representing business data and logic. It is an implementation of <a href="http://en.wikipedia.org/wiki/Active_record_pattern" target="_blank">the Active Record pattern</a> which itself is a description of an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping" target="_blank">Object Relational Mapping</a> (ORM) system.</p>
      <p>Active Record gives us several mechanisms, the most important being the ability to:</p>
      <ul>
        <li>Represent models and their data</li>
        <li>Represent associations between these models</li>
        <li>Represent inheritance hierarchies through related models</li>
        <li>Validate models before they get persisted to the database</li>
        <li>Perform database operations in an object-oriented fashion</li>
      </ul>
    </div>
  </div>
</section>
<section id="models-generation" class="slide">
  <h2>Models generation</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
     rails generate model User first_name:string email:string password:string
      invoke  active_record
      create    db/migrate/20130602143931_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      test/unit/user_test.rb
      create      test/fixtures/users.yml

    ]]>
  </script>

  <h3>Naming Conventions</h3>
  <ul>
    <li>Database Table - Plural with underscores separating words (e.g., book_clubs)</li>
    <li>Model Class - Singular with the first letter of each word capitalized (e.g., BookClub)</li>
  </ul>
  <table class="naming-conventions">
    <thead>
      <tr>
        <th>Model / Class</th>
        <th>Table / Schema</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>Post</code></td>
        <td><code>posts</code></td>
      </tr>
      <tr>
        <td><code>LineItem</code></td>
        <td><code>line_items</code></td>
      </tr>
      <tr>
        <td><code>Deer</code></td>
        <td><code>deer</code></td>
      </tr>
      <tr>
        <td><code>Mouse</code></td>
        <td><code>mice</code></td>
      </tr>
      <tr>
        <td><code>Person</code></td>
        <td><code>people</code></td>
      </tr>
    </tbody>
  </table>
</section><section id="migrations-topic" class="slide">
  <div class="vcenter">
    <h1>Active Record Migrations</h1>
    <div class="about">
      <p><strong>Migrations</strong> are a feature of Active Record that allows you to evolve your database schema over time. Rather than write schema modifications in pure SQL, migrations allow you to use an easy Ruby DSL to describe changes to your tables.</p>
    </div>
  </div>
</section>
<section id="migrations" class="slide">
  <h2>Overview</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      class CreateUsers < ActiveRecord::Migration
        def change
          create_table :users do |t|
            t.string :first_name
            t.string :email
            t.string :password

            t.timestamps
          end
        end
      end
    ]]>
  </script>
  
  <h3>Schema Conventions</h3>
  <ul>
    <li><strong>Foreign keys</strong> - These fields should be named following the pattern singularized_table_name_id (e.g., item_id, order_id). These are the fields that Active Record will look for when you create associations between your models.</li>
    <li><strong>Primary keys</strong> - By default, Active Record will use an integer column named id as the table's primary key. When using Rails Migrations to create your tables, this column will be automatically created.</li>
    <li><strong>created_at</strong> - Automatically gets set to the current date and time when the record is first created.</li>
    <li><strong>updated_at</strong> - Automatically gets set to the current date and time whenever the record is updated.</li>
    <li><strong>lock_version</strong> - Adds optimistic locking to a model.</li>
    <li><strong>type</strong> - Specifies that the model uses Single Table Inheritance.</li>
    <li><strong>(association_name)_type</strong> - Stores the type for polymorphic associations.</li>
    <li><strong>(table_name)_count</strong> - Used to cache the number of belonging objects on associations. For example, a comments_count column in a Post class that has many instances of Comment will cache the number of existent comments for each post.</li>
  </ul>
</section><section id="add-migrations" class="slide">
  <h2>Add Migrations</h2>

  <script type="syntaxhighlighter" class="brush: bash">
  <![CDATA[
    rails g migration AddLastNameToUsers last_name:string
      invoke  active_record
      create    db/migrate/20130602150030_add_last_name_to_users.rb

  ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
  <![CDATA[
    YYYYMMDDHHMMSS UTC timestamp
    20130602150030_add_last_name_to_users.rb
  ]]>
  </script>

  db/migrate/20130602150030_add_last_name_to_users.rb 
  <script type="syntaxhighlighter" class="brush: ruby">
  <![CDATA[
     class AddLastNameToUsers < ActiveRecord::Migration
      def change
        add_column :users, :last_name, :string
      end
    end
  ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
  <![CDATA[
    rails g migration AddReceiveNewsToUsers receive_news:boolean
      invoke  active_record
      create    db/migrate/20130602151002_add_receive_news_to_users.rb
  ]]>
  </script>

  db/migrate/20130602151002_add_receive_news_to_users.rb
  <script type="syntaxhighlighter" class="brush: ruby">
  <![CDATA[
    class AddReceiveNewsToUsers < ActiveRecord::Migration
      def change
        add_column :users, :receive_news, :boolean
      end
    end
  ]]>
  </script>

  db/migrate/20130602151002_add_receive_news_to_users.rb
  <script type="syntaxhighlighter" class="brush: ruby">
  <![CDATA[
    class AddReceiveNewsToUsers < ActiveRecord::Migration
      def up
        change_table :users do |t|
          t.boolean :receive_news, default: true
          t.index :receive_news
        end

        User.update_all ["receive_news = ?", true]
      end

      def down
        remove_column :users, :receive_news
      end
    end
  ]]>
  </script>
</section><section id="db-changing-methods" class="slide">
  <h2>Methods for db structure changing</h2>
  
  <code>create_table</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
      create_table :friends do |t|
        t.string :first_name
        t.string :last_name
        t.string :email
        t.timestamps
      end
    ]]>
  </script>
  
  <code>change_table</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
      change_table :friends do |t|
        t.remove :last_name, :first_name
        t.string :phone_number
        t.index  :phone_number
      end
    ]]>
  </script>
  
  <code>add_column</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      add_column :friends, :first_name, :string
      add_column :friends, :last_name, :integer
    ]]>
  </script>

  <code>change_column</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      change_column :friends, :last_name, :string
    ]]>
  </script>

  <code>rename_column</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      rename_column :friends, :last_name, :surname
    ]]>
  </script>

  <code>remove_column</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      remove_column :friends, :surname
    ]]>
  </script>

  <code>add_index</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      add_index :friends, :email
    ]]>
  </script>

  <code>remove_index</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      remove_index :friends, :email
    ]]>
  </script>

  <code>drop_table</code>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      drop_table :friends
    ]]>
  </script>
</section><section id="column-types" class="slide">
  <h2>Column Types</h2>
  <ul>
    <li><code>:binary</code></li>
    <li><code>:boolean</code></li>
    <li><code>:date</code></li>
    <li><code>:datetime</code></li>
    <li><code>:decimal</code></li>
    <li><code>:float</code></li>
    <li><code>:integer</code></li>
    <li><code>:primary_key</code></li>
    <li><code>:string</code></li>
    <li><code>:text</code></li>
    <li><code>:time</code></li>
    <li><code>:timestamp</code></li>
    <li><code>:references</code></li>
  </ul>
</section><section id="example-migration" class="slide">
  <h2>Example Migration</h2>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class ExampleMigration < ActiveRecord::Migration
      def up
        create_table :users do |t|
          t.references :group
        end
        #add a foreign key
        execute <<-SQL
          ALTER TABLE products
            ADD CONSTRAINT fk_users_groups
            FOREIGN KEY (group_id)
            REFERENCES groups(id)
        SQL
        add_column :users, :home_page_url, :string
        rename_column :users, :email, :email_address
      end
     
      def down
        rename_column :users, :email_address, :email
        remove_column :users, :home_page_url
        execute <<-SQL
          ALTER TABLE users
            DROP FOREIGN KEY fk_users_groups
        SQL
        drop_table :users
      end
    end
    ]]>
  </script>
 
</section><section id="running-migrations" class="slide">
  <h2>Run run run ruuuuuuuuun</h2>
  <h3>Running Migrations</h3>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
        rake db:migrate     
    ]]>
  </script>

  <h3>Rollback Migrations</h3>
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
        rake db:rollback
        rake db:rollback STEP=3
        rake db:migrate:down VERSION=20111214211749  
        rake db:migrate:up VERSION=20111214211749
        rake db:migrate:redo STEP=3
           
    ]]>
  </script>

 
</section><section id="topic-active-record-objects" class="slide">
  <div class="vcenter">
    <h1>Active Record Objects</h1>
  </div>
</section>
<section id="activerecord-functions" class="slide">
  <h2>ActiveRecord functions</h2>
  
  <h3>new, all, save</h3>
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    rails c  # rails console 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    2.0.0-p0 :003 > user = User.new
     => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false >]   
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    2.0.0-p0 :001 > user.first_name = "Anna"
     => "Anna" 
    2.0.0-p0 :003 > user.email = "happy_ann@gmail.com"
     => "happy_ann@gmail.com" 
    2.0.0-p0 :004 > user.save
      (0.2ms)  begin transaction
      SQL (29.9ms)  INSERT INTO "users" ("created_at", "email", "first_name", "last_name", "password", "receive_news", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 17:23:02 UTC +00:00], ["email", "happy_ann@gmail.com"], ["first_name", "Anna"], ["last_name", nil], ["password", nil], ["receive_news", false], ["updated_at", Sun, 02 Jun 2013 17:23:02 UTC +00:00]]
       (125.5ms)  commit transaction
     => true 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    2.0.0-p0 :005 > User.all
      User Load (0.4ms)  SELECT "users".* FROM "users" 
     => [#<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>]  
    ]]>
  </script>

  <h3>Rails 3</h3>
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    2.0.0-p0 :006 > User.all.class
      User Load (0.6ms)  SELECT "users".* FROM "users" 
     => Array 
    
    ]]>
  </script>

  <h3>Rails 4</h3>
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    2.0.0-p0 :007 > User.all.class
      User Load (0.6ms)  SELECT "users".* FROM "users" 
     => ActiveRecord::Relation     
    ]]>
  </script>
 
</section><section id="activerecord-functions-part2" class="slide">
  <h2>ActiveRecord functions</h2>
  <h3>create, count, update_attributes</h3>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[  
    2.0.0-p0 :001 > new_user = User.create(first_name: "Ivan", email: "ivan.melechov@gmail.com")
      (0.1ms)  begin transaction
      SQL (3.0ms)  INSERT INTO "users" ("created_at", "email", "first_name", "last_name", "password", "receive_news", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 18:18:40 UTC +00:00], ["email", "ivan.melechov@gmail.com"], ["first_name", "Ivan"], ["last_name", nil], ["password", nil], ["receive_news", false], ["updated_at", Sun, 02 Jun 2013 18:18:40 UTC +00:00]]
      (125.0ms)  commit transaction
     => #<User id: 2, first_name: "Ivan", email: "ivan.melechov@gmail.com", password: nil, created_at: "2013-06-02 18:18:40", updated_at: "2013-06-02 18:18:40", last_name: nil, receive_news: false> 
  ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
   <![CDATA[  
   2.0.0-p0 :002 > User.count
     (0.2ms)  SELECT COUNT(*) FROM "users" 
    => 2      
   ]]>
  </script>


  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[  
    2.0.0-p0 :003 > new_user.update_attributes(first_name: "Van'ka", email: "vanka@yandex.ru")
     (0.2ms)  begin transaction
     (0.5ms)  UPDATE "users" SET "first_name" = 'Van''ka', "email" = 'vanka@yandex.ru', "updated_at" = '2013-06-02 18:20:00.982364' WHERE "users"."id" = 2
     (124.8ms)  commit transaction
     => true 
        
    ]]>
  </script> 
</section><section id="topic-associations" class="slide">
  <div class="vcenter">
    <h1>Active Record Associations</h1>
  </div>
</section>
<section id="belongs-to" class="slide">
  <h2>belongs_to</h2>
  <img src="/assets/images/belongs_to.png" />
</section>
<section id="belongs-to-in-model" class="slide">
  <h2>belongs_to</h2>
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
      rails g migration AddUserRefToPosts user:references
      invoke  active_record
      create    db/migrate/20130615164224_add_user_ref_to_posts.rb
    ]]>
  </script>

  db/migrate/20130615164224_add_user_ref_to_posts.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[      
      class AddUserRefToPosts < ActiveRecord::Migration
        def change
          add_reference :posts, :user, index: true
        end
      end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
      rake db:migrate
      ==  AddUserRefToPosts: migrating ==============================================
      -- add_reference(:posts, :user, {:index=>true})
         -> 0.0053s
      ==  AddUserRefToPosts: migrated (0.0054s) =====================================
    ]]>
  </script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[      
    class Post < ActiveRecord::Base
      belongs_to :user
    end    
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > user = User.first
      User Load (0.4ms)  SELECT "users".* FROM "users" LIMIT 1
      => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false> 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    > post = Post.create(text: "I'm so happy today", title: "So happy", user_id: user.id) 
      (0.1ms)  begin transaction
      SQL (29.2ms)  INSERT INTO "posts" ("created_at", "text", "title", "updated_at", "user_id") VALUES (?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 18:43:10 UTC +00:00], ["text", "I'm so happy today"], "So happy", ["updated_at", Sun, 02 Jun 2013 18:43:10 UTC +00:00], ["user_id", 1]]
      (126.0ms)  commit transaction
      => #<Post id: 1, text: "I'm so happy today", title: "So happy", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10"> 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
    > post.user
      User Load (0.4ms)  SELECT "users".* FROM "users" WHERE "users"."id" = 1 LIMIT 1
      => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>  
    ]]>
  </script>
</section>
<section id="has-many" class="slide">
  <h2>has_many</h2>
  <img src="/assets/images/has_many.png" />
</section>
<section id="has_many_in_model" class="slide">
  <h2>has_many</h2>

  app/models/user.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class User < ActiveRecord::Base
      has_many :posts
    end     
    ]]>
  </script>

   <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    > user.posts
      Post Load (0.2ms)  SELECT "posts".* FROM "posts" WHERE "posts"."user_id" = 1
      => [#<Post id: 1, text: "I'm so happy today", title: "So happy", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10">] 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
    > user.posts << Post.new(text: "I'm waiting")
      (0.2ms)  begin transaction
      SQL (32.4ms)  INSERT INTO "posts" ("created_at", "text",  "updated_at", "user_id") VALUES (?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 19:01:45 UTC +00:00], ["text", "I'm waiting"], ["updated_at", Sun, 02 Jun 2013 19:01:45 UTC +00:00], ["user_id", 1]]
      (203.0ms)  commit transaction
      => [#<Post id: 1, text: "I'm so happy today", title: "So happy", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10">, #<Post id: 2, text: "I'm waiting", title: nil, user_id: 1, created_at: "2013-06-02 19:01:45", updated_at: "2013-06-02 19:01:45">] 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    > user.posts
      => [#<Post id: 1, text: "I'm so happy today", title: "So happy", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10">, #<Post id: 2, text: "I'm waiting", title: nil, user_id: 1, created_at: "2013-06-02 19:01:45", updated_at: "2013-06-02 19:01:45">] 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    > user.posts.count
      (0.2ms)  SELECT COUNT(*) FROM "posts" WHERE "posts"."user_id" = 1
      => 2 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    > user.posts.create(text: "New post")
      (0.2ms)  begin transaction
      SQL (0.8ms)  INSERT INTO "posts" ("created_at", "text","updated_at", "user_id") VALUES (?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 19:06:35 UTC +00:00], ["text", "New post"], ["updated_at", Sun, 02 Jun 2013 19:06:35 UTC +00:00], ["user_id", 1]]
      (140.8ms)  commit transaction
      => #<Post id: 3, text: "New post", title: nil, user_id: 1, created_at: "2013-06-02 19:06:35", updated_at: "2013-06-02 19:06:35"> 
    ]]>
  </script>
</section><section id="has-one" class="slide">
  <h2>has_one</h2>
  <img src="/assets/images/has_one.png" />
</section>
<section id="has-one-in-model" class="slide">
  <h2>has_one</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    rails g model PostInfo post_id:integer views:integer likes:integer rating:integer
    ]]>
  </script>

  app/models/post_info.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[      
    class PostInfo < ActiveRecord::Base
      belongs_to :post
    end
    ]]>
  </script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[      
    class Post < ActiveRecord::Base
      belongs_to :user
      has_one :post_info
    end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > post = Post.first
      Post Load (0.1ms)  SELECT "posts".* FROM "posts" LIMIT 1
      => #<Post id: 1, text: "I'm so happy today", user_id: 1, created_at: "2013-06-02 18:43:10", updated_at: "2013-06-02 18:43:10"> 

    ]]>
  </script>

  Creation PostInfo
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > PostInfo.create(post_id: post.id, views: 40, likes: 5, rating: 10)
      (0.1ms)  begin transaction
      SQL (5.1ms)  INSERT INTO "post_infos" ("created_at", "likes", "post_id", "rating", "updated_at", "views") VALUES (?, ?, ?, ?, ?, ?)  [["created_at", Sun, 02 Jun 2013 19:37:08 UTC +00:00], ["likes", 5], ["post_id", 1], ["rating", 10], ["updated_at", Sun, 02 Jun 2013 19:37:08 UTC +00:00], ["views", 40]]
      (116.2ms)  commit transaction
      => #<PostInfo id: 2, post_id: 1, views: 40, likes: 5, rating: 10, created_at: "2013-06-02 19:37:08", updated_at: "2013-06-02 19:37:08"> 
    ]]>
  </script>

  Creation using the association
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
    > post.create_post_info(views: 40, likes: 5, rating: 10)
      (0.2ms)  begin transaction
      SQL (29.4ms) INSERT INTO "post_infos" ("created_at", "likes", "post_id", "rating", "updated_at", "views") VALUES (?, ?, ?, ?, ?, ?)  [["created_at", Sun, 16 Jun 2013 20:21:58 UTC +00:00], ["likes", 5], ["post_id", 1], ["rating", 10], ["updated_at", Sun, 16 Jun 2013 20:21:58 UTC +00:00], ["views", 40]]
      (1.5ms)  commit transaction
      => #<PostInfo id: 1, post_id: 1, views: 40, likes: 5, rating: 10, created_at: "2013-06-16 20:21:58", updated_at: "2013-06-16 20:21:58">
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > post.post_info
      PostInfo Load (0.2ms)  SELECT "post_infos".* FROM "post_infos" WHERE "post_infos"."post_id" = 1 LIMIT 1
      => #<PostInfo id: 1, post_id: 1, views: 40, likes: 5, rating: 10, created_at: "2013-06-02 19:34:38", updated_at: "2013-06-02 19:34:38"> 
    ]]>
  </script>
</section>
<section id="has-many-through" class="slide">
  <h2>has_many :through</h2>
  <img src="/assets/images/has_many_through.png" />
</section>
<section id="has-many-through-in-model" class="slide">
  <h2>has_many :through</h2>
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
      rails g model Blog title:string description:text
      invoke  active_record
      create    db/migrate/20130615195018_create_blogs.rb
      create    app/models/blog.rb
      invoke    test_unit
      create      test/models/blog_test.rb
      create      test/fixtures/blogs.yml
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
      rails g model Subscription user:belongs_to blog:belongs_to receive_news:boolean
      invoke  active_record
      create    db/migrate/20130615200154_create_subscriptions.rb
      create    app/models/subscription.rb
      invoke    test_unit
      create      test/models/subscription_test.rb
      create      test/fixtures/subscriptions.yml
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
      rails g migration AddBlogRefToPosts blog:references
      invoke  active_record
      create    db/migrate/20130616200237_add_blog_ref_to_posts.rb
    ]]>
  </script>

  db/migrate/20130615195018_create_blogs.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      class CreateBlogs < ActiveRecord::Migration
        def change
          create_table :blogs do |t|
            t.string :title
            t.text :description

            t.timestamps
          end
        end
      end
    ]]>
  </script>

  db/migrate/20130615200154_create_subscriptions.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      class CreateSubscriptions < ActiveRecord::Migration
        def change
          create_table :subscriptions do |t|
            t.belongs_to :user, index: true
            t.belongs_to :blog, index: true
            t.boolean :receive_news, default: true

            t.timestamps
          end
        end
      end
    ]]>
  </script>

  db/migrate/20130616200237_add_blog_ref_to_posts.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      class AddBlogRefToPosts < ActiveRecord::Migration
        def change
          add_reference :posts, :blog, index: true
        end
      end
    ]]>
  </script>

  app/models/user.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      class User < ActiveRecord::Base
        has_many :posts
        has_many :subscriptions
        has_many :blogs, through: :subscriptions
      end
    ]]>
  </script>

  app/models/blog.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      class Blog < ActiveRecord::Base
        has_many :subscriptions
        has_many :users, through: :subscriptions
      end
    ]]>
  </script>

  app/models/subscription.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      class Subscription < ActiveRecord::Base
        belongs_to :user
        belongs_to :blog
      end
    ]]>
  </script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
      class Post < ActiveRecord::Base
        belongs_to :user
        belongs_to :blog
        has_one :post_info
        has_and_belongs_to_many :tags
      end
    ]]>
  </script>
</section><section id="has-one-through" class="slide">
  <h2>has_one :through</h2>
  <img src="/assets/images/has_one_through.png" />
</section>
<section id="has-one-through-in-model" class="slide">
  <h2>has_one :through</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
    rails g model Plan name:string description:text price:decimal{8.2}
      invoke  active_record
      create    db/migrate/20130616211135_create_plans.rb
      create    app/models/plan.rb
      invoke    test_unit
      create      test/models/plan_test.rb
      create      test/fixtures/plans.yml
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
    rails g model UserPlan user:belongs_to plan:belongs_to
      invoke  active_record
      create    db/migrate/20130616211306_create_user_plans.rb
      create    app/models/user_plan.rb
      invoke    test_unit
      create      test/models/user_plan_test.rb
      create      test/fixtures/user_plans.yml
    ]]>
  </script>

  db/migrate/20130616211135_create_plans.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
    class CreatePlans < ActiveRecord::Migration
      def change
        create_table :plans do |t|
          t.string :name
          t.text :description
          t.decimal :price, precision: 8, scale: 2

          t.timestamps
        end
      end
    end
    ]]>
  </script>


  db/migrate/20130616211306_create_user_plans.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
    class CreateUserPlans < ActiveRecord::Migration
      def change
        create_table :user_plans do |t|
          t.belongs_to :user, index: true
          t.belongs_to :plan, index: true

          t.timestamps
        end
      end
    end
    ]]>
  </script>

  app/models/user.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
    class User < ActiveRecord::Base
      has_many :posts
      has_many :subscriptions
      has_many :blogs, through: :subscriptions
      has_one :user_plan
      has_one :plan, through: :user_plan
    end
    ]]>
  </script>

  app/models/user_plan.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class UserPlan < ActiveRecord::Base
      belongs_to :user
      belongs_to :plan
    end
    ]]>
  </script>

  app/models/plan.rb
  <script type="syntaxhighlighter" class="brush: ruby">
  <![CDATA[    
    class Plan < ActiveRecord::Base
      has_many :user_plans
      has_many :users, through: :user_plans
    end
    ]]>
  </script>
</section><section id="has_and_belongs_to_many" class="slide">
  <h2>has_and_belongs_to_many</h2>
  <img src="/assets/images/has_and_belongs_to_many.png" />
</section>
<section id="habtm-in-model" class="slide">
  <h2>has_and_belongs_to_many</h2>
  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    rails g model Tag name:string
      invoke  active_record
      create    db/migrate/20130615203349_create_tags.rb
      create    app/models/tag.rb
      invoke    test_unit
      create      test/models/tag_test.rb
      create      test/fixtures/tags.yml
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    rails g migration create_posts_tags post:references tag:references --no-timestamp
      invoke  active_record
      create    db/migrate/20130615205723_create_posts_tags.rb
    ]]>
  </script>

<h3>Rails 4</h3>
    <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    create_join_table :posts, :tags
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    create_join_table :posts, :tags, table_name: :tags_for_posts
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
      create_join_table :posts, :tags, column_options:  {null:  true}
    ]]>
  </script>
 
  db/migrate/20130615205723_create_posts_tags.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class CreatePostsTags < ActiveRecord::Migration
      def change
        create_table :posts_tags do |t|
          t.references :post, index: true
          t.references :tag, index: true
        end
      end
    end
    ]]>
  </script>

  <h4>Change migration. Add common index and remove id.</h4>
  db/migrate/20130615205723_create_posts_tags.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class CreatePostsTags < ActiveRecord::Migration
      def change
        create_table :posts_tags, id: false do |t|
          t.references :post, index: true
          t.references :tag, index: true
        end
        add_index :posts_tags, [:post_id, :tag_id]
      end
    end
    ]]>
  </script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
      class Post < ActiveRecord::Base
        belongs_to :user
        has_and_belongs_to_many :tags
      end
    ]]>
  </script>

  app/models/tag.rb
  <script type="syntaxhighlighter" class="brush: ruby">
  <![CDATA[    
    class Tag < ActiveRecord::Base
      has_and_belongs_to_many :posts
    end  
  ]]>
  </script>

</section><section id="polymorphic" class="slide">
  <h2>Polymorphic Associations</h2>
  <img src="/assets/images/polymorphic.png" />
</section>
<section id="polymorphic-in-model" class="slide">
  <h2>Polymorphic Assosiations</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
      rails g model Picture imageable:references{polymorphic} file:string
      invoke  active_record
      create    db/migrate/20130616213914_create_pictures.rb
      create    app/models/picture.rb
      invoke    test_unit
      create      test/models/picture_test.rb
      create      test/fixtures/pictures.yml
    ]]>
  </script>

  db/migrate/20130616213914_create_pictures.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[
    class CreatePictures < ActiveRecord::Migration
      def change
        create_table :pictures do |t|
          t.references :imageable, polymorphic: true, index: true
          t.string :file

          t.timestamps
        end
      end
    end
    ]]>
  </script>

  app/models/picture.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class Picture < ActiveRecord::Base
      belongs_to :imageable, polymorphic: true
    end      
    ]]>
  </script>

  app/models/user.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class User < ActiveRecord::Base
      has_many :posts
      has_many :subscriptions
      has_many :blogs, through: :subscriptions
      has_one :user_plan
      has_one :plan, through: :user_plan
      has_one :picture, as: :imageable
    end
    ]]>
  </script>

  app/models/post.rb
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class Post < ActiveRecord::Base
      belongs_to :user
      belongs_to :blog
      has_one :post_info
      has_and_belongs_to_many :tags
      has_many :pictures, as: :imageable
    end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
    > user.create_picture(file: 'public/picture/photo.png')
      (0.1ms)  begin transaction
      SQL (32.7ms)  INSERT INTO "pictures" ("created_at", "file", "imageable_id", "imageable_type", "updated_at") VALUES (?, ?, ?, ?, ?)  [["created_at", Sun, 16 Jun 2013 21:46:37 UTC +00:00], ["file", "public/picture/photo.png"], ["imageable_id", 1], ["imageable_type", "User"], ["updated_at", Sun, 16 Jun 2013 21:46:37 UTC +00:00]]
      (1.5ms)  commit transaction
      Picture Load (0.4ms)  SELECT "pictures".* FROM "pictures" WHERE "pictures"."imageable_id" = ? AND "pictures"."imageable_type" = ? ORDER BY "pictures"."id" ASC LIMIT 1  [["imageable_id", 1], ["imageable_type", "User"]]
      => #<Picture id: 1, imageable_id: 1, imageable_type: "User", file: "public/picture/photo.png", created_at: "2013-06-16 21:46:37", updated_at: "2013-06-16 21:46:37">
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[
    > post.pictures.create(file: 'public/picture/image.png')
      (0.1ms)  begin transaction
      SQL (0.6ms)  INSERT INTO "pictures" ("created_at", "file", "imageable_id", "imageable_type", "updated_at") VALUES (?, ?, ?, ?, ?)  [["created_at", Sun, 16 Jun 2013 21:51:25 UTC +00:00], ["file", "public/picture/image.png"], ["imageable_id", 1], ["imageable_type", "Post"], ["updated_at", Sun, 16 Jun 2013 21:51:25 UTC +00:00]]
      (1.7ms)  commit transaction
      => #<Picture id: 2, imageable_id: 1, imageable_type: "Post", file: "public/picture/image.png", created_at: "2013-06-16 21:51:25", updated_at: "2013-06-16 21:51:25">
    ]]>
  </script>
</section><section id="topic-validations" class="slide">
  <div class="vcenter">
    <h1>Active Record Validations</h1>
  </div>
</section>
<section id="when-does-validation-happen" class="slide">
  <h2>When Does Validations Happen?</h2>
  <ul>
    <li><code>create</code></li>
    <li><code>create!</code></li>
    <li><code>save</code></li>
    <li><code>save!</code></li>
    <li><code>update</code></li>
    <li><code>update!</code></li>
  </ul>
</section><section id="skipping-validations" class="slide">
  <h2>Skiping Validations</h2>
  <ul>
    <li><code>decrement!</code></li>
    <li><code>decrement_counter</code></li>
    <li><code>increment!</code></li>
    <li><code>increment_counter</code></li>
    <li><code>toggle!</code></li>
    <li><code>touch</code></li>
    <li><code>update_all</code></li>
    <li><code>update_attribute</code></li>
    <li><code>update_column</code></li>
    <li><code>update_columns</code></li>
    <li><code>update_counters</code></li>
    <li><code>save(validate: false)</code></li>
  </ul>
</section><section id="valid-invalid" class="slide">
  <h2>valid? and invalid?</h2>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[      
    class User < ActiveRecord::Base
      has_many :posts
      validates :email, presence: true
    end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > User.new(email: "thebestemail@ua.fm").valid?
      => true 
    > User.new().valid?
      => false 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > u = User.new
      => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false> 
    > u.errors
      => #<ActiveModel::Errors:0x00000003001970 @base=#<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false>, @messages={}> 
    > u.valid?
      => false 
    > u.errors
      => #<ActiveModel::Errors:0x00000003001970 @base=#<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false>, @messages={:email=>["can't be blank"]}> 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > u = User.create
        (0.2ms)  begin transaction
        (0.1ms)  rollback transaction
      => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false> 
    > u.errors
      => #<ActiveModel::Errors:0x00000003172db8 @base=#<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false>, @messages={:email=>["can't be blank"]}> 
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > u = User.new
      => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false> 
    > u.save
        (0.2ms)  begin transaction
        (0.1ms)  rollback transaction
      => false 
    > u.save!
       (0.1ms)  begin transaction
       (0.1ms)  rollback transaction
      ActiveRecord::RecordInvalid: Validation failed: Email cant be blank
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[      
    > User.create
        (0.1ms)  begin transaction
        (0.1ms)  rollback transaction
      => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false> 
    > User.create!
        (0.1ms)  begin transaction
        (0.1ms)  rollback transaction
      ActiveRecord::RecordInvalid: Validation failed: Email cant be blank
    ]]>
  </script>
</section><section id="errors" class="slide">
  <h2>errors[]</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    > User.new.errors[:email].any?
      => false 
    > User.create.errors[:email].any?
       (0.1ms)  begin transaction
       (0.1ms)  rollback transaction
      => true 
    ]]>
  </script>
 
</section><section id="topic-validation-helpers" class="slide">
  <div class="vcenter">
    <h1>Active Record Validations</h1>
    <h2>Helpers</h2>
  </div>
</section><section id="presence" class="slide">
  <h2>Presence</h2>
<script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class User < ActiveRecord::Base
      attr_accessible :email, :first_name, :password

      has_many :posts
      validates :email, :first_name, presence: true
    end     
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    validates :field_name, inclusion: { in:  [true, false] }. # for fields with boolean type
    ]]>
  </script>

</section><section id="acceptance" class="slide">
  <h2>Acceptance</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[       
    rails g migration AddTermsOfServiceToUsers terms_of_service:boolean
    ]]>
  </script>

<script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[       
    class User < ActiveRecord::Base  
      ... 
      validates :terms_of_service, acceptance: true  # get accept: 1
    end   
    ]]>
  </script>
  
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[     
    class User < ActiveRecord::Base   
      ...
      validates :terms_of_service, acceptance: { accept: 'yes' }  
    end
    ]]>
  </script>
  <p>Do not this validation on the both sides of the association it causes endless cycle.</p>

</section><section id="validates-associated" class="slide">
  <h2>Validates Assosiated</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base  
      ... 
      has_many :posts
      validates_associated :posts
    end
    ]]>
  </script>
</section><section id="confirmation" class="slide">
  <h2>Confirmation</h2>
<script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[       
    class User < ActiveRecord::Base
      ...
      validates :email, :first_name, presence: true
      validates :email, confirmation: true
    end 
    ]]>
  </script>

</section><section id="exclusion" class="slide">
  <h2>Exclusion</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class User < ActiveRecord::Base
      ...
      validates :first_name, exclusion: { in:  %w(Admin BadDog),  message:  "First name %{value} is invalid." }
    end
    ]]>
  </script>
</section><section id="format" class="slide">
  <h2>Format</h2>
<script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class User < ActiveRecord::Base
      ...
      validates :email, :first_name, presence: true
      validates :email, confirmation: true
      validates :email, format: { with: /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/, :message => "Only emails allowed" }
    end    
    ]]>
  </script>

</section><section id="inclusion" class="slide">
  <h2>Inclusion</h2>
<script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class Tag < ActiveRecord::Base
      ...
      validates :name, inclusion: { in: %w(reading cooking programming), message: "%{value} is not a valid value" }
    end   
    ]]>
  </script>

</section><section id="length" class="slide">
  <h2>Length</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[ 
    rails g migration AddCardNumberToUsers card_number:string
    ]]>
  </script>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class User < ActiveRecord::Base
      ...
      validates :first_name, length: { 
        minimum: 2, 
        maximum: 500, 
        wrong_length: "Invalid length",
        too_long: "%{count} characters is the maximum allowed" 
        too_short: "must have at least %{count} characters"
      }
      validates :password, length: { in: 6..20 }
      validates :card_number, length:  { is: 14 }
    end
    ]]>
  </script>

  <ul>
    <li><code>:minimum</code> – The attribute cannot have less than the specified length.</li>
    <li><code>:maximum</code> – The attribute cannot have more than the specified length.</li>
    <li><code>:in</code> (or <code>:within</code>) – The attribute length must be included in a given interval. The value for this option must be a range.</li>
    <li><code>:is</code> – The attribute length must be equal to the given value.</li>
  </ul>
</section><section id="numericality" class="slide">
  <h2>Numericality</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class PostInfo < ActiveRecord::Base
      ...
      validates :views, numericality: true
      validates :rate, numericality: { only_integer: true, greater_than: 5 }
    end   
    ]]>
  </script>

  <ul>
    <li><code>:greater_than</code></li>
    <li><code>:greater_than_or_equal_to</code></li>
    <li><code>:equal_to</code></li>
    <li><code>:less_than</code></li>
    <li><code>:less_than_or_equal_to</code></li>
    <li><code>:odd</code></li>
    <li><code>:even</code></li>
  </ul>
</section><section id="uniqueness" class="slide">
  <h2>Uniqueness</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
    rails g AddPageAddressToUsers page_address:string    
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class User < ActiveRecord::Base
      ... 
      validates :email, uniqueness: true
      validates :first_name, uniqueness: { scope: :email,  message: "should only one user with name and email" }
      validates :page_address, uniqueness: { case_sensitive:  false }
    end
    
    ]]>
  </script>
</section><section id="validates-with" class="slide">
  <h2>validates_with</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base
      validates_with GoodnessValidator
    end
     
    class GoodnessValidator < ActiveModel::Validator
      def validate(record)
        if record.first_name == "Evil"
          record.errors[:base] << "This user is evil"
        end
      end
    end
    ]]>
  </script>

   <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base
      validates_with GoodnessValidator, fields: [:first_name, :last_name]
    end
     
    class GoodnessValidator < ActiveModel::Validator
      def validate(record)
        if options[:fields].any?{|field| record.send(field) == "Evil" }
          record.errors[:base] << "This user is evil"
        end
      end
    end
    ]]>
  </script>
</section><section id="validate-each" class="slide">
  <h2>validate_each</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base
      validates_each :first_name, :last_name do |record, attr, value|
        record.errors.add(attr, 'must start with upper case') if value =~ /\A[a-z]/
      end
    end
    ]]>
  </script>

</section><section id="general-options" class="slide">
  <h2>General options</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class Post < ActiveRecord::Base
      validates :title, allow_nil: true
    end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base
      validates :last_name, allow_blank: true
    end
    ]]>
  </script>

  <p>:allow_nil and :allow_blank are ignored by :presence</p>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base
      # it will be possible to update email with a duplicated value
      validates :email, uniqueness: true, on: :create
     
      # it will be possible to create the record with a non-numerical age
      validates :card_number, numericality: true, on: :update
     
      # the default (validates on both create and update)
      validates :first_name, presence: true, on: :save
    end
    ]]>
  </script>

</section><section id="conditional-validations" class="slide">
  <h2>Condional validations</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
      class User < ActiveRecord::Base
        validates :card_number, presence: true, if: :paid_with_card?
       
        def paid_with_card?
          payment_type == "card"
        end
      end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
      validates :last_name, presence: true, if: "first_name.nil?"
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
      validates :password, confirmation: true, unless: Proc.new { |a| a.password.blank? }
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
      with_options if: :is_admin? do |admin|
        admin.validates :password, length: { minimum: 10 }
        admin.validates :email, presence: true
      end
    ]]>
  </script>

</section><section id="topic-custom-validations" class="slide">
  <div class="vcenter">
    <h1>Active Record Validations</h1>
    <h2>Custom Validations</h2>
  </div>
</section>
<section id="custom-validators" class="slide">
  <h2>Custom Validators</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class MyValidator < ActiveModel::Validator
      def validate(record)
        unless record.first_name.starts_with? 'X'
          record.errors[:first_name] << 'Need a name starting with X please!'
        end
      end
    end
     
    class User
      include ActiveModel::Validations
      validates_with MyValidator
    end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class EmailValidator < ActiveModel::EachValidator
      def validate_each(record, attribute, value)
        unless value =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i
          record.errors[attribute] << (options[:message] || "is not an email")
        end
      end
    end
     
    class User < ActiveRecord::Base
      validates :email, presence: true, email: true
    end
    ]]>
  </script>

</section><section id="custom-methods" class="slide">
  <h2>Custom Methods</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[    
      rails g model Payment discount:decimal{8.2} total_value:decimal{8.2} expiration_date:date
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[    
    class Payment < ActiveRecord::Base
      belongs_to :user_plan
      validate :expiration_date_cannot_be_in_the_past,
        :discount_cannot_be_greater_than_total_value
     
      def expiration_date_cannot_be_in_the_past
        if !expiration_date.blank? and expiration_date < Date.today
          errors.add(:expiration_date, "can't be in the past")
        end
      end
     
      def discount_cannot_be_greater_than_total_value
        if discount > total_value
          errors.add(:discount, "can't be greater than total value")
        end
      end
    end
    ]]>
  </script>

</section><section id="validation-errors" class="slide">
  <h2>Validation Errors</h2>
  <h3>errors.add</h3>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base
      def a_method_used_for_validation_purposes
        errors.add(:first_name, "cannot contain the characters !@#%*()_-+=")
        # errors[:first_name] = "cannot contain the characters !@#%*()_-+="
      end
    end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    user = User.create(:first_name => "!@#")     
    user.errors[:first_name] # => ["cannot contain the characters !@#%*()_-+="]
    user.errors.full_messages  # => ["Name cannot contain the characters !@#%*()_-+="]
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base
      def a_method_used_for_validation_purposes
        errors[:base] << "This user is invalid because ..."
      end
    end
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
      errors.clear
    ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
      errors.size
    ]]>
  </script>

</section><section id="topic-callbacks" class="slide">
  <div class="vcenter">
    <h1>Active Record Callbacks</h1>
  </div>
</section>
<section id="callback-registrations" class="slide">
  <h2>Callback registrations</h2>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[ 
    rails g migration AddLoginToUsers login:string
    ]]>
  </script>
  
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[ 
    class User < ActiveRecord::Base  
      ... 
      validates :login, :email, presence: true
 
      before_validation :ensure_login_has_a_value

      before_create do |user|
        user.first_name = user.login.capitalize if user.first_name.blank?
      end
     
      protected
      
      def ensure_login_has_a_value
        if login.nil?
          self.login = email unless email.blank?
        end
      end
    end
    ]]>
  </script>
</section><section id="availiable-callbacks" class="slide">
  <h2>Availiable Callbacks</h2>
  <h3>Creating an Object</h3>
  <ol>
    <li><code>before_validation</code></li>
    <li><code>after_validation</code></li>
    <li><code>before_save</code></li>
    <li><code>around_save</code></li>
    <li><code>before_create</code></li>
    <li><code>around_create</code></li>
    <li><code>after_create</code></li>
    <li><code>after_save</code></li>
  </ol>
  
  <h3>Updating an Object</h3>
  <ol>
    <li><code>before_validation</code></li>
    <li><code>after_validation</code></li>
    <li><code>before_save</code></li>
    <li><code>around_save</code></li>
    <li><code>before_update</code></li>
    <li><code>around_update</code></li>
    <li><code>after_update</code></li>
    <li><code>after_save</code></li>
  </ol>
    
  <h3>Destroying an Object</h3>
  <ol>
    <li><code>before_destroy</code></li>
    <li><code>around_destroy</code></li>
    <li><code>after_destroy</code></li>
  </ol>
</section><section id="after-callbacks" class="slide">
  <h2>After_find and after_initialize</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[     
    
    class User < ActiveRecord::Base
      after_initialize do |user|
        puts "You have initialized an object!"
      end
     
      after_find do |user|
        puts "You have found an object!"
      end
    end
     
    >> User.new
    You have initialized an object!
    => #<User id: nil, first_name: nil, email: nil, password: nil, created_at: nil, updated_at: nil, last_name: nil, receive_news: false>
     
    >> User.first
    You have found an object!
    You have initialized an object!
    => #<User id: 1, first_name: "Anna", email: "happy_ann@gmail.com", password: nil, created_at: "2013-06-02 17:23:02", updated_at: "2013-06-02 17:23:02", last_name: nil, receive_news: false>

    ]]>
  </script>

</section><section id="running-callbacks" class="slide">
  <h2>Running Callbacks</h2>
  <ul>
    <li><code>create</code></li>
    <li><code>create!</code></li>
    <li><code>decrement!</code></li>
    <li><code>destroy</code></li>
    <li><code>destroy_all</code></li>
    <li><code>increment!</code></li>
    <li><code>save</code></li>
    <li><code>save!</code></li>
    <li><code>save(:validate => false)</code></li>
    <li><code>toggle!</code></li>
    <li><code>update</code></li>
    <li><code>update_attribute</code></li>
    <li><code>update_attributes</code></li>
    <li><code>update_attributes!</code></li>
    <li><code>valid?</code></li>
  </ul>
  <h2>after_find</h2>
  <ul>
    <li><code>all</code></li>
    <li><code>first</code></li>
    <li><code>find</code></li>
    <li><code>find_all_by_attribute</code></li>
    <li><code>find_by_attribute</code></li>
    <li><code>find_by_attribute!</code></li>
    <li><code>last</code></li>
  </ul>
</section><section id="skipping-callbacks" class="slide">
  <h2>Skipping callbacks</h2>
  <ul>
    <li><code>decrement</code></li>
    <li><code>decrement_counter</code></li>
    <li><code>delete</code></li>
    <li><code>delete_all</code></li>
    <li><code>find_by_sql</code></li>
    <li><code>increment</code></li>
    <li><code>increment_counter</code></li>
    <li><code>toggle</code></li>
    <li><code>touch</code></li>
    <li><code>update_column</code></li>
    <li><code>update_all</code></li>
    <li><code>update_counters</code></li>
  </ul>
</section><section id="relational-callbacks" class="slide">
  <h2>Relational Callbacks</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[     
    class User < ActiveRecord::Base
      ...
      has_many :posts, dependent: :destroy
    end
 
    class Post < ActiveRecord::Base
      ...
      after_destroy :log_destroy_action
     
      def log_destroy_action
        puts 'Post destroyed'
      end
    end     
  ]]>
  </script>

  <script type="syntaxhighlighter" class="brush: bash">
    <![CDATA[     
    > user = User.first
      => #<User id: 1>
    > user.posts.create!
      => #<Post id: 1, user_id: 1>
    > user.destroy
      # Post destroyed
      => #<User id: 1>
    ]]>
  </script>
</section><section id="conditional-callbacks" class="slide">
  <h2>Conditional Callbacks</h2>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[     
    before_save :normalize_card_number, if: :paid_with_card?
    before_save :normalize_card_number, if: "paid_with_card?"
    before_save :normalize_card_number, if: Proc.new { |order| order.paid_with_card? }
    after_create :send_email_to_user,   if: :user_wants_emails?, unless: Proc.new { |comment| comment.post.ignore_comments? }
  ]]>
  </script>
</section><section id="callback-classes" class="slide">
  <h2>Callback Classes</h2>
  
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[     
    class PictureFileCallbacks
      def after_destroy(picture_file)
        if File.exists?(picture_file.filepath)
          File.delete(picture_file.filepath)
        end
      end
    end
  ]]>
  </script>
   <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[     
    class PictureFile < ActiveRecord::Base
      after_destroy PictureFileCallbacks.new
    end
  ]]>
  </script>
  <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[     
     class PictureFileCallbacks
      def self.after_destroy(picture_file)
        if File.exists?(picture_file.filepath)
          File.delete(picture_file.filepath)
        end
      end
    end
  ]]>
  </script>
   <script type="syntaxhighlighter" class="brush: ruby">
    <![CDATA[     
     class PictureFile < ActiveRecord::Base
      after_destroy PictureFileCallbacks
    end
  ]]>
  </script>
</section>

<!-- End slides. -->

<!-- deck.navigation snippet -->
<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<!-- deck.status snippet -->
<p class="deck-status">
  <span class="deck-status-current"></span>
  /
  <span class="deck-status-total"></span>
</p>

<!-- deck.hash snippet -->
<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

</body>
</html>
